---
title: "DualPAMImportData"
author:
- Julie A. Nadeau
- Mireille Savoie
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
    code_folding: hide
    keep_md: yes
    fig_caption: yes
    toc: TRUE
    toc_float: TRUE   
csl: plos-one.csl
---

This .Rmd imports and tidys underlying data from the DualPAM kinetic fluorometer/absorbtometer software, along with culture MetaData and Turner Chlorophyll data. 

# Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Set Project Variables

```{r set project variables}
Project <- "PICO"
DataOut <- file.path("..", "Data", "ProcessedData")

Run <- "O2Analyses"

#ExpDate <- "2023-05-27" #date of first MultiCulti growth start

DataIn <- file.path("..", "Data", "RawData", "DualPAM", "Report", fsep = .Platform$file.sep)

FileID <- ".csv"

# Catalog <- "https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0"
# 
# ChlTurner <- "https://docs.google.com/spreadsheets/d/13mQm0B3siS65UuGjNdzvpHFomfuwn6aAg7dBoq1IqrM/edit#gid=0"

FileEncode <- "UTF-8" 
Delimiter <- ";"

#number of rows in each individual run, including Fo, Fm & 12 actinic light levels
LightSteps <- 15

#HeaderRows <- 14

#TempCont <- "TC"

```

```{r conversions}
us_s <- 1000000
photons_umol <- 6.022E17
A2_m2 <- 1E20
```

```{r load libraries}
library(tidyverse)
library(lubridate)
library(photobiologyWavebands) #R colours from nm values
library(broom) #formatting model outputs

#https://googlesheets4.tidyverse.org/
library(googledrive)
library(googlesheets4)

```

Load Multiculti catalog and ChlTurner

```{r load multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

# imagine this is the URL or ID of a Sheet readable by anyone (with a link)
# MultiCulti metadata
MetaData <- read_sheet(Catalog)%>%
  # read_sheet has an annoying "feature" to set the type of columns it can't parse to a list.
  # ggplot/dplyr doesn't like working with a dataframe of lists.
  # In this case WL is set to a list since some values are numbers, some are strings, some are blank.
  # To fix this, first drop all rows missing WL, then unlist.
  # Must first drop NA rows since unlist will collapse NULL lists, then the unlisted WL is a shorter length than original WL column, which mutate doesn't like.
  drop_na(WL) %>%
  mutate(WL = unlist(WL))

as.data.frame(MetaData)

MetaData <- MetaData %>%
   mutate(ExpDate = lubridate::ymd(ExpDate),
          ExpEndDate = lubridate::ymd_hms(`ExpEndDate`))
# find units for chl

#issue with R guessing coltype of InstrumentTag from first rows, and converting to lgl.  Then actual tags are lost as NA b/c looking for logical values only
#ChlData <- read_sheet(ChlTurner, col_types = c("cccciiiiiiic"))

#head(ChlData)

# ChlData <- ChlData|>
#   mutate(Chl_ugL = as.numeric(Reading_rfu) * as.numeric(`Chl_slope_RFU/Chl (ug/L)`) + as.numeric(Chl_intercept_RFU)) |>
#   drop_na(DATE, TIME) |>
#   #mutate(StartExDate = unlist(StartExDate),
#   # mutate(DATE = unlist(DATE), 
#   #        TIME = unlist(TIME)) |>
#   mutate(DATE = as.character(DATE)) |>
#   filter(InstrumentTag == "Solisense")

# ,
#          StartExDate = as.character(StartExDate))
  # read_sheet has an annoying "feature" to set the type of columns it can't parse to a list.
  # ggplot/dplyr doesn't like working with a dataframe of lists.

#head(ChlData)
```

```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c(w_length2rgb(Wavelengths_nm[1]), w_length2rgb(Wavelengths_nm[2]), w_length2rgb(Wavelengths_nm[3]), w_length2rgb(Wavelengths_nm[4]), w_length2rgb(Wavelengths_nm[5]))

names(Colours_nm) <- Wavelengths_nm
Colours_nm

```

```{r list DualPAM Report files for file import}
DualPAMFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE, recursive = FALSE)

DualPAMFiles

#test for duplicate file names
unique(duplicated(DualPAMFiles))
```

```{r data read adds filename and cdate, warning=FALSE, message=FALSE, echo=FALSE}

#a read function using tidyverse::read_delim that skips a fixed number of header rows, and adds columns to the dataframe containing the filename and the file creation date time.
read_delim_plus <- function(flnm, delimiter, headerrows, fileencode){read_delim(flnm, delim = delimiter,  col_names = TRUE,  skip = headerrows, escape_double = FALSE,  locale = locale(encoding = fileencode), trim_ws = TRUE) %>%
    mutate(Filename = flnm)
}

```

Read Test File
DualPAM data is appending desired RLC data to previously captured data.
Need to select final XX rows of each file to get the 'last' captured RLC, b/c as runs accumulate, saved files increase in length/rows.

```{r read example DualPAM Report file}
DataHeaderRows <- 0

TestFile <- read_delim_plus(flnm = "../Data/RawData/DualPAM/Report/202311091032_PICO_JuNa1210_2.csv", delimiter = Delimiter, headerrows = DataHeaderRows, fileencode = FileEncode) |>
  slice_tail(n = LightSteps) |>
  select(-c(`k/ocs`, `F(I)/Fo calc`, `FMTm`, `F/Fm`,`Fm'/Fm`, `Y(4S)`, `...32`)) |>
  filter(Action != c("LC-Start", "Manual", "LC-Stop")) |>
  rename(FI = `F(I)`,
         Fo = `Fo,Fo'`,
         Fm = `Fm,Fm'`,
         YII = `Y(II)`,
         ETRII = `ETR(II)`,
         YNO = `Y(NO)`,
         YNPQ = `Y(NPQ)`,
         P700m = `P700m,P700m'`,
         YI = `Y(I)`,
         YND = `Y(ND)`,
         YNA = `Y(NA)`,
         ETRI = `ETR(I)`)
  

head(TestFile)

TestFile2 <- type_convert(
  TestFile,
  col_types = NULL,
  na = c("", "NA"),
  trim_ws = TRUE,
  locale = default_locale(),
  guess_integer = FALSE
)

head(TestFile2)

TestFile3 <- TestFile2 |>
  mutate(Filename = str_remove(Filename, pattern = "../Data/RawData/DualPAM/Report/")) |>
  mutate(Filename = str_remove(Filename, pattern = ".csv")) |>
 separate_wider_delim(Filename, delim = "_",  names = c("RunDateTime", "Project", "CultureID", "MeasureO2_uM"), cols_remove = FALSE) |>
  mutate(RunDateTime = ymd_hm(RunDateTime)) 


#../Data/RawData/DualPAM/Report/202311071209_PICO_JuNa1201_250.csv

```

```{r testplots}
TestFile |>
  ggplot() +
  geom_point(aes(x = PAR, y = YI), colour = "blue") +
  geom_point(aes(x = PAR, y = YII), colour = "red") +
  theme_bw()

TestFile |>
  ggplot() +
  geom_point(aes(x = YII, y = YI)) +
  theme_bw()

```

```{r read and tidy function}
read_delim_DualPAM <- function(flnm, delimiter, headerrows, fileencode){read_delim_plus(flnm, delimiter = Delimiter, headerrows = DataHeaderRows, fileencode = FileEncode) |>
    slice_tail(n = LightSteps) |>
    select(-c(`k/ocs`, `F(I)/Fo calc`, `FMTm`, `F/Fm`,`Fm'/Fm`, `Y(4S)`, `...32`)) |>
    filter(Action != c("LC-Start", "Manual", "LC-Stop")) |>
    rename(FI = `F(I)`,
         Fo = `Fo,Fo'`,
         Fm = `Fm,Fm'`,
         YII = `Y(II)`,
         ETRII = `ETR(II)`,
         YNO = `Y(NO)`,
         YNPQ = `Y(NPQ)`,
         P700m = `P700m,P700m'`,
         YI = `Y(I)`,
         YND = `Y(ND)`,
         YNA = `Y(NA)`,
         ETRI = `ETR(I)`) |>
    type_convert() |>
    mutate(Filename = str_remove(Filename, pattern = "../Data/RawData/DualPAM/Report/")) |>
    mutate(Filename = str_remove(Filename, pattern = ".csv")) |>
    separate_wider_delim(Filename, delim = "_",  names = c("RunDateTime", "Project", "CultureID", "MeasureO2_uM"), cols_remove = FALSE) |>
    mutate(RunDateTime = ymd_hm(RunDateTime)) 
}
```


```{r read example DualPAMData file onestep}
DataHeaderRows <- 0

DualPAMOneStep <- read_delim_DualPAM(flnm = "../Data/RawData/DualPAM/Report/202311071209_PICO_JuNa1201_250.csv", delimiter = Delimiter, headerrows = DataHeaderRows, fileencode = FileEncode)



```


purrr::map to read all files, onestep read_delim_SolLightTime function

```{r read Solisense files}
DataHeaderRows <- 0

DualPAMData <- DualPAMFiles |>
  map_df(~ read_delim_DualPAM(flnm =., delimiter = Delimiter, headerrows = DataHeaderRows, fileencode = FileEncode))


head(DualPAMData)
colnames(DualPAMData)
length(unique(DualPAMData$Filename))
```

```{r DualPAMData plot}
DualPAMData |>
  ggplot() +
  geom_point(aes(x = PAR, y = YI), colour = "blue") +
  geom_point(aes(x = PAR, y = YII), colour = "red") +
  facet_grid(cols = vars(MeasureO2_uM), rows = vars(CultureID)) +
  theme_bw()

DualPAMData |>
  filter(MeasureO2_uM %in% c(2, 25, 250)) |>
  ggplot() +
  geom_point(aes(x = PAR, y = YI), colour = "blue") +
  geom_point(aes(x = PAR, y = YII), colour = "red") +
  facet_grid(cols = vars(MeasureO2_uM), rows = vars(CultureID)) +
  theme_bw()

DualPAMData |>
  filter(MeasureO2_uM %in% c(2, 25, 250)) |>
  ggplot() +
  geom_point(aes(x = YII, y = YI)) +
  facet_grid(cols = vars(MeasureO2_uM), rows = vars(CultureID)) +
  theme_bw()

```

# Merge with MetaData & Turner Chl Data

```{r merge with metadata}
# SolData <- SolData |>
#   separate(col = StartDateTimeSol, into = c("StartDateSol", "StartTimeSol"), sep = " ", remove = FALSE) |>
#   relocate(.after = StartDateTimeSol)
# 
# SolDataMeta <- left_join(x = SolData, y = MetaData, join_by("CultureID" == "ID")) |>
#   mutate(O2_uM = case_when(O2 == 0 ~ 2,
#                            O2 == 1 ~ 25,
#                            O2 == 21 ~ 250)) |>
#   select(-c("Description", "Motivation", "doi", "Par_ueAdjusted", "DateOfAdjustment", "ElaspedHoursAtAdjustment", "...44", "...45")) 
# 
# 
# SolDataMeta <- left_join(x = SolDataMeta, y = ChlData, join_by("CultureID" == "CultureID"))

#", "StartDateSol" == "DATE""
```


```{r save DualPAMMeta}
# saveRDS(SolDataMeta, file.path(DataOut, paste(Project, Run, "SolDataMeta.Rds", sep = "_"), fsep = .Platform$file.sep))
```
