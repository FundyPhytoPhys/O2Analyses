---
title: "Deconvolute OLIS UVVISspectral data data"
author: "Douglas A. Campbell"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

# To Do
-plot actual fitted peaks, not just peak centres (just for display)
  Do later for example plots?
  How to plot dnorm with centre, width and height
  
-implement 'global' fitting where peak position and peak width are constant across multiple spectra but peak amplitude is allowed to vary
  Done using 2nd derivatives of set of spectra, averaged to a common 2nd derivative spectra to ID peaks.

# Import spectral files generated by OLIS spectrophotometer

```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(googledrive)
library(googlesheets4)
library(broom)
library(minpack.lm)
#library(nlme) for mixed effects models with global and local parameters; https://stackoverflow.com/questions/70653677/using-nls-or-nlslm-to-fit-global-and-group-specific-parameters/70659535
library(zoo)
library(ggspectra)
library(photobiologyWavebands)
library(photobiology)


```

```{r set project variables}
#"..", takes up a level in the directory path
Project <- "PICO"

#FileID <- "OlisDeco"
DataIn <- file.path("..","Data", "ImportedData", "OLIS")

DataOut <- file.path("..", "Data", "ProcessedData")

FileEncode <- "UTF-8" 
#Delimiter <- "\t"
```


```{r set colours}
Wavelengths_nm = c("WW", 470, 530, 660)

Colours_nm = c("black", "dodgerblue", "darkgreen", "red")

names(Colours_nm) <- Wavelengths_nm
Colours_nm

```


i) Check changes in pigment peak heights across growth conditions within a strain
ii) How do pigments change over growth trajectory within a strain
iii) Check OLIS spectra correlated with calculated pigment contents; Yes

iv) Evaluate pigment content per cell and per ml (with cell counts)

So: Will need to extract values for particular absorbance peaks
Possibly: Deconvolute absorbance peaks into separate contributions from multiple different pigments  (Need to find appropriate package(s) for this)

Need to implement plots overlaying spectra from the same strain under different growth conditions.
Need to implement plots overlaying spectra from the same strain at different growth points

Think about matrix plot with perhaps strain, Par_ue, WL, photoperiod, growth stage as 'visual grammar'

Find code from light attenuation work to show rainbow colour gradient 'rug' along bottom.

# Read Spectra
```{r read spectra}
#Spectra <- readRDS(file = file.path("..", DataPath, "PICO_OLISSpectraMetaCCAChosen.Rds"))
```


OLIS file
Exported from OlisImportCorrPICO.Rmd only first time in session
```{r list tidied data files}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

Read File
```{r read ImportedFile}
OlisDecoFile <- "../ImportedData/OLIS/PICO_OLISSpectraMetaCCAChosen.Rds"

OlisDecoFileName <- str_split(string = OlisDecoFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

OlisDecoData <- readRDS(OlisDecoFile) %>%
  ungroup()

colnames(OlisDecoData)
```



# Generate plot with panels grouped by strain, growth light colour and growth light level
Something going wrong; 11,000 rows lost; issue with SampleID?
There is something wrong with SampleID and Filename; I think more than one spectra are saved under the same name?

#!!!! Spectra are already normalized to 710!!!
```{r filter spectra}
SpectraFilterMid <- OlisDecoData |>
  #filter(E_days %in% c(7,8)) |>
  filter(nm >= 400) |>
  # filter(str_detect(ID, "SySl")) |>
  group_by(ID, E_days) |>
  mutate(AbsBase = Absorbance - Absorbance[nm == 710]) |>
  ungroup()
  
```

```{r facetted plot}
SpectraFilterMid |> 
  ggplot() +
  geom_point(aes(x = nm, y = AbsBase, colour = as.factor(WL)), size = 0.1) +
  scale_colour_manual(values = Colours_nm) +
  facet_grid(rows = vars(Strain), cols = vars(Par_ue, Photoperiod)) +
  theme_bw()

```


# Generate Test Spectra set
```{r select a test spectra}
# TestSpectra <- Spectra[2353:3360, 1:6] |>
#   filter(nm >= 400) |>
#   group_by(SampleID) |>
#   mutate(AbsBase = Abs - Abs[nm == 710]) |>
#   ungroup()
# 
# 
# #something is going wrong with AbsBase; it should always have 710 = 0
# TestSpectra2 <- Spectra[, 1:6] |>  
#   filter(nm >= 400) |>
#   filter(str_detect(SampleID, "SySl")) |>
#   group_by(SampleID) |>
#   mutate(AbsBase = Abs - Abs[nm == 710]) |>
#   filter(max(AbsBase, na.rm = TRUE) >= 0.015) |>
#   ungroup()
# 
#   
# 
# #save TestSpectra
# #write_csv(x = TestSpectra, file = "TestSpectra2.csv")
# 
# 
# TestSpectra %>% ggplot() +
#   geom_point(aes(x = nm, y = AbsBase, colour = SampleID)) +
#   theme_bw()
# 
# TestSpectra2 %>% 
#   ggplot() +
#   geom_point(aes(x = nm, y = AbsBase, colour = SampleID)) +
#   theme_bw()

```

# Use 2nd Derivative to find peak positions

```{r second derivative}
#https://stackoverflow.com/questions/49762128/rolling-regression-by-group-in-the-tidyverse?noredirect=1&lq=1

#function to generate slope from ratio of covariance to variance
slope <- . %>% { cov(.[, 2], .[, 1]) / var(.[, 2])}

#range rolling window variables; be careful with different data sets
NmperRow <- ((SpectraFilterMid$nm[length(SpectraFilterMid$nm)]- SpectraFilterMid$nm[1]) +1)/nrow(SpectraFilterMid)
FirstRange <- 10
SecondRange <- 10

# SpectraFilterMid <- SpectraFilterMid  |>
#   group_by(Filename) |>
#   mutate(FirstDer = rollapplyr(cbind(AbsBase, nm), FirstRange, slope, by.column = FALSE, align = 'center', fill = NA)) |>
#   mutate(SecDer = rollapplyr(cbind(FirstDer, nm), SecondRange, slope, by.column = FALSE, align = 'center', fill = NA)) |>
#   ungroup()

SpectraFilterMid <- SpectraFilterMid  |>
  group_by(ID, E_days) |>
  mutate(FirstDer = rollapplyr(cbind(AbsBase, nm), FirstRange, slope, by.column = FALSE, align = 'center', fill = NA)) |>
  mutate(SecDer = rollapplyr(cbind(FirstDer, nm), SecondRange, slope, by.column = FALSE, align = 'center', fill = NA)) |>
  ungroup()

#average 2nd derivative across spectra
#Decide whether to pool all data from Strain x WL, or to pool by Strain x WL x Par_ue
#, Par_ue,
SpectraFilterMid <- SpectraFilterMid |>
  group_by(nm, Strain, WL, Par_ue, Photoperiod) |>
  mutate(SecDerAv = mean(SecDer)) |>
  ungroup() |>
  mutate(SecDerNeg = if_else(SecDerAv < 0, SecDerAv, NA_real_),
         Peaks = if_else(SecDerNeg < lag(SecDerNeg, n = 1) & SecDerNeg < lead(SecDerNeg, n = 1), SecDerNeg, NA_real_))

```



```{r fig.height = 6, fig.width = 8}

Xvar = sym("nm")
Yvar = sym("AbsBase")

Groupvar1 = sym("ID")
Groupvar2 = sym("WL")
Groupvar3 = sym("Strain")
Groupvar4 = sym("Par_ue")
Groupvar5 = sym("Photoperiod")
TargetStrain = sym("BA127R, BA77G")

#add sec.axis labels to put variable names on facets
SpectraFilterMid |> 
  ggplot() +
  geom_point(aes(x = !!Xvar, y = !!Yvar), size = 0.1) + 
  geom_line(aes(x = !!Xvar, y = SecDerAv * 50)) +
  geom_point(aes(x = !!Xvar, y = Peaks * 50), colour = "darkred", size = 0.2) +
  geom_text(aes(x = !!Xvar, y = Peaks * 50, label = nm), angle = 45, colour = "darkred", nudge_x = -0.01, nudge_y = -0.001, size = 2) + 
  #facet_grid(cols = vars(!!Groupvar3), rows = vars(!!Groupvar4, !!Groupvar5)) +
  # scale_x_continuous(sec.axis = sec_axis(~ . , name = Groupvar3, breaks = NULL, labels = NULL)) +
  # scale_y_continuous(sec.axis = sec_axis(~ . , name = paste(Groupvar4, Groupvar5, sep = ", "), breaks = NULL, labels = NULL)) +
  labs(y = "Absorbance", x = "Wavelength (nm)") +
    ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, WL = label_both, Par_ue = label_both, Strain = label_value)) +
theme_bw() +
      theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.direction="horizontal",
        legend.position = c(0.08,0.97),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text.align = 0,
        #legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.3, 'cm'),
        legend.text = element_text(size=10))

```


Now:
-use peak positions to guide deconvolution
-number of peak positions varies with strain (and possibly with PAR_ue if included)
-need to generate spectra specific data nests with spectra specific peak nests and peak counts to assign fit to proper fitting equation.
-use map2 passing spectra data and peak data into fit

-other approachs reference to generalize 'global' fitting in a single run without prior finding of peaks.
https://stackoverflow.com/questions/70653677/using-nls-or-nlslm-to-fit-global-and-group-specific-parameters/70659535
https://stats.stackexchange.com/questions/44246/nls-curve-fitting-of-nested-shared-parameters

```{r peak fitting functions}
# https://lmi.cnrs.fr/r/fitting.html
#Create functions to fit the data

# fitting 7, 8, 9 peaks;
#if fitting AbsBase set y0 =  0 b/c baseline already subtracted
# write more sophisticated function with number of peaks taken dynamically from length(Peaks) or from PeakCount
# possible using 'reformulate'
# https://stackoverflow.com/questions/65092749/how-to-pass-loop-results-as-initial-parameters-for-nlslm-model

#These functions get values for peak positions x1 to xn passed in as a vector 'peaks', previously generated by using 2nd derivative functions across nests of spectra

peakfunc7 <- function(x, y0, peaks, sd1, sd2, sd3, sd4, sd5, sd6, sd7,  A1, A2, A3, A4, A5, A6,A7) {y0 + A1 * dnorm(x, mean = peaks[[1]], sd = sd1) + A2 * dnorm(x, mean = peaks[[2]], sd = sd2) + A3 * dnorm(x, mean = peaks[[3]], sd = sd3) + A4 * dnorm(x, mean = peaks[[4]], sd = sd4) + A5 * dnorm(x, mean = peaks[[5]], sd = sd5) + A6 * dnorm(x, mean = peaks[[6]], sd = sd6) + A7 * dnorm(x, mean = peaks[[7]], sd = sd7)
}

peakfunc8 <- function(x, y0, peaks, sd1, sd2, sd3, sd4, sd5, sd6, sd7, sd8, A1, A2, A3, A4, A5, A6,A7, A8) {y0 + A1 * dnorm(x, mean = peaks[[1]], sd = sd1) + A2 * dnorm(x, mean = peaks[[2]], sd = sd2) + A3 * dnorm(x, mean = peaks[[3]], sd = sd3) + A4 * dnorm(x, mean = peaks[[4]], sd = sd4) + A5 * dnorm(x, mean = peaks[[5]], sd = sd5) + A6 * dnorm(x, mean = peaks[[6]], sd = sd6) + A7 * dnorm(x, mean = peaks[[7]], sd = sd7) + A8 * dnorm(x, mean = peaks[[8]], sd = sd8)
}

peakfunc9 <- function(x, y0, peaks, sd1, sd2, sd3, sd4, sd5, sd6, sd7, sd8, sd9, A1, A2, A3, A4, A5, A6, A7, A8, A9) {y0 + A1 * dnorm(x, mean = peaks[[1]], sd = sd1) + A2 * dnorm(x, mean = peaks[[2]], sd = sd2) + A3 * dnorm(x, mean = peaks[[3]], sd = sd3) + A4 * dnorm(x, mean = peaks[[4]], sd = sd4) + A5 * dnorm(x, mean = peaks[[5]], sd = sd5) + A6 * dnorm(x, mean = peaks[[6]], sd = sd6) + A7 * dnorm(x, mean = peaks[[7]], sd = sd7) + A8 * dnorm(x, mean = peaks[[8]], sd = sd8) + A9 * dnorm(x, mean = peaks[[9]], sd = sd9)
}

peakfunc10 <- function(x, y0, peaks, sd1, sd2, sd3, sd4, sd5, sd6, sd7, sd8, sd9, sd10, A1, A2, A3, A4, A5, A6, A7, A8, A9, A10) {y0 + A1 * dnorm(x, mean = peaks[[1]], sd = sd1) + A2 * dnorm(x, mean = peaks[[2]], sd = sd2) + A3 * dnorm(x, mean = peaks[[3]], sd = sd3) + A4 * dnorm(x, mean = peaks[[4]], sd = sd4) + A5 * dnorm(x, mean = peaks[[5]], sd = sd5) + A6 * dnorm(x, mean = peaks[[6]], sd = sd6) + A7 * dnorm(x, mean = peaks[[7]], sd = sd7) + A8 * dnorm(x, mean = peaks[[8]], sd = sd8) + A9 * dnorm(x, mean = peaks[[9]], sd = sd9) + A10 * dnorm(x, mean = peaks[[10]], sd = sd10)
}


```


```{r fit peaks}
SpectraPeaks <- SpectraFilterMid |>
  select(c(ID, E_days, nm, Peaks)) |>
  filter(!is.na(Peaks)) |>
  nest(PeakData = c(nm, Peaks)) |>
  mutate(PeakCount = map_dbl(PeakData, ~ sum(!is.na(.$Peaks)))) %>%
  filter(PeakCount %in% c(6,7,8,9,10)) #filter out spectra with dubious peak assignments for now

SpectraNestsMid <- SpectraFilterMid |>
  select(-Peaks) |>
  nest(SpecData = -c(ID, E_days))

SpectraNestsMid <- left_join(x = SpectraPeaks, y = SpectraNestsMid, by = c("ID", "E_days"))

#better programming could use PeakCount to dynamically generate functions of the appropriate length; 


# SpectraNestsMid7<- SpectraNestsMid |>
#   filter(PeakCount == 7) |>
#   mutate(PeakFits = map2(.x = SpecData, .y = PeakData, possibly(~nlsLM(.x$AbsBase ~ peakfunc7(x = .x$nm, y0 = 0, peaks = .y$nm, sd1, sd2, sd3, sd4, sd5, sd6, sd7,  A1, A2, A3, A4, A5, A6,A7),
#                       data = .x,
#                       start = list(sd1 = 10, sd2 = 10, sd3 = 10, sd4 = 10, sd5 = 10, sd6 = 10, sd7 = 10, A1 = 0.5, A2 = 0.5, A3 = 0.5, A4 = 0.5, A5 = 0.5, A6 = 0.5, A7 = 0.5),
#                       control = list(maxiter = 500)), otherwise = NULL))
#   ) %>%
#    mutate(PeakFitValues = map(PeakFits, possibly(tidy, otherwise = NULL))
#           )

SpectraNestsMid8 <- SpectraNestsMid |>
  filter(PeakCount == 8) |>
  mutate(PeakFits = map2(.x = SpecData, .y = PeakData, possibly(~nlsLM(.x$AbsBase ~ peakfunc8(x = .x$nm, y0 = 0, peaks = .y$nm, sd1, sd2, sd3, sd4, sd5, sd6, sd7,sd8,  A1, A2, A3, A4, A5, A6,A7, A8),
                      data = .x,
                      start = list(sd1 = 10, sd2 = 10, sd3 = 10, sd4 = 10, sd5 = 10, sd6 = 10, sd7 = 10, sd8 = 10,  A1 = 0.5, A2 = 0.5, A3 = 0.5, A4 = 0.5, A5 = 0.5, A6 = 0.5, A7 = 0.5, A8 = 0.5),
                     control = list(maxiter = 500)), otherwise = NULL))
  ) %>%
   mutate(PeakFitValues = map(PeakFits, possibly(tidy, otherwise = NULL))
          )

SpectraNestsMid9 <- SpectraNestsMid |>
  filter(PeakCount == 9) |>
  mutate(PeakFits = map2(.x = SpecData, .y = PeakData, possibly(~nlsLM(.x$AbsBase ~ peakfunc9(x = .x$nm, y0 = 0, peaks = .y$nm, sd1, sd2, sd3, sd4, sd5, sd6, sd7,sd8, sd9, A1, A2, A3, A4, A5, A6,A7, A8,A9),
                      data = .x,
                      start = list(sd1 = 10, sd2 = 10, sd3 = 10, sd4 = 10, sd5 = 10, sd6 = 10, sd7 = 10, sd8 = 10, sd9 = 10, A1 = 0.5, A2 = 0.5, A3 = 0.5, A4 = 0.5, A5 = 0.5, A6 = 0.5, A7 = 0.5, A8 = 0.5, A9 = 0.5),
                      control = list(maxiter = 500)), otherwise = NULL))
  ) %>%
   mutate(PeakFitValues = map(PeakFits, possibly(tidy, otherwise = NULL))
          )

SpectraNestsMid10 <- SpectraNestsMid |>
  filter(PeakCount == 10) |>
  mutate(PeakFits = map2(.x = SpecData, .y = PeakData, possibly(~nlsLM(.x$AbsBase ~ peakfunc10(x = .x$nm, y0 = 0, peaks = .y$nm, sd1, sd2, sd3, sd4, sd5, sd6, sd7,sd8, sd9, sd10, A1, A2, A3, A4, A5, A6,A7, A8,A9, A10),
                      data = .x,
                      start = list(sd1 = 10, sd2 = 10, sd3 = 10, sd4 = 10, sd5 = 10, sd6 = 10, sd7 = 10, sd8 = 10, sd9 = 10, sd10 = 10, A1 = 0.5, A2 = 0.5, A3 = 0.5, A4 = 0.5, A5 = 0.5, A6 = 0.5, A7 = 0.5, A8 = 0.5, A9 = 0.5, A10 = 0.5),
                      control = list(maxiter = 500)), otherwise = NULL))
  ) %>%
   mutate(PeakFitValues = map(PeakFits, possibly(tidy, otherwise = NULL))
          )


```

```{r assemble peaks}
#Figure out how to re-connect spectral positions with amplitudes & sd by unnesting, pivoting etc.

#brittle solution with 'bind_cols'

# PeakAmps7 <- SpectraNestsMid7 |>
#   select(-c(SpecData, PeakFits, PeakData, )) |>
#   unnest(cols = c(PeakFitValues)) |>
#   select(-c(PeakCount, statistic, p.value)) |>
#   filter(str_detect(string = term, pattern = "A[:digit:]")) |>
#   select(-c(term, ID, E_days))
# 
# Peaksd7 <- SpectraNestsMid7 |>
#   select(-c(SpecData, PeakFits, PeakData)) |>
#   unnest(cols = c(PeakFitValues)) |>
#   select(-c(PeakCount, statistic, p.value)) |>
#   filter(str_detect(string = term, pattern = "sd[:digit:]")) |>
#   select(-c(term, ID, E_days))
# 
# Peaknm7 <- SpectraPeaks |>
#   filter(PeakCount == 7) |>
#   unnest(PeakData) |>
#   select(-c(Peaks))
# 
# Peaks7 <- bind_cols(Peaknm7, PeakAmps7, Peaksd7, .name_repair = "unique") |>
#   rename(Amp = estimate...5,
#          std.errAmp = std.error...6,
#          SD = estimate...7,
#          std.errSD = std.error...8)

PeakAmps8 <- SpectraNestsMid8 |>
  select(-c(SpecData, PeakFits, PeakData)) |>
  unnest(cols = c(PeakFitValues)) |>
  select(-c(PeakCount, statistic, p.value)) |>
  filter(str_detect(string = term, pattern = "A[:digit:]")) |>
  select(-c(term, ID, E_days))

Peaksd8 <- SpectraNestsMid8 |>
  select(-c(SpecData, PeakFits, PeakData)) |>
  unnest(cols = c(PeakFitValues)) |>
  select(-c(PeakCount, statistic, p.value)) |>
  filter(str_detect(string = term, pattern = "sd[:digit:]")) |>
  select(-c(term, ID, E_days))

Peaknm8 <- SpectraPeaks |> 
  filter(PeakCount == 8) |> 
  unnest(PeakData) |>
  select(-c(Peaks))

Peaks8 <- bind_cols(Peaknm8, PeakAmps8, Peaksd8, .name_repair = "unique") |>
  rename(Amp = estimate...5,
         std.errAmp = std.error...6,
         SD = estimate...7,
         std.errSD = std.error...8)

PeakAmps9 <- SpectraNestsMid9 |>
  select(-c(SpecData, PeakFits, PeakData)) |>
  unnest(cols = c(PeakFitValues)) |>
  select(-c(PeakCount, statistic, p.value)) |>
  filter(str_detect(string = term, pattern = "A[:digit:]")) |>
  select(-c(term, ID, E_days))

Peaksd9 <- SpectraNestsMid9 |>
  select(-c(SpecData, PeakFits, PeakData)) |>
  unnest(cols = c(PeakFitValues)) |>
  select(-c(PeakCount, statistic, p.value)) |>
  filter(str_detect(string = term, pattern = "sd[:digit:]")) |>
  select(-c(term, ID, E_days))

Peaknm9 <- SpectraPeaks |> 
  filter(PeakCount == 9) |> 
  unnest(PeakData) |>
  select(-c(Peaks))

Peaks9 <- bind_cols(Peaknm9, PeakAmps9, Peaksd9, .name_repair = "unique") |>
  rename(Amp = estimate...5,
         std.errAmp = std.error...6,
         SD = estimate...7,
         std.errSD = std.error...8)
  

PeakAmps10 <- SpectraNestsMid10 |>
  select(-c(SpecData, PeakFits, PeakData)) |>
  unnest(cols = c(PeakFitValues)) |>
  select(-c(PeakCount, statistic, p.value)) |>
  filter(str_detect(string = term, pattern = "A[:digit:]")) |>
  select(-c(term, ID, E_days))

Peaksd10 <- SpectraNestsMid10 |>
  select(-c(SpecData, PeakFits, PeakData)) |>
  unnest(cols = c(PeakFitValues)) |>
  select(-c(PeakCount, statistic, p.value)) |>
  filter(str_detect(string = term, pattern = "sd[:digit:]")) |>
  select(-c(term, ID, E_days))

Peaknm10 <- SpectraPeaks |> 
  filter(PeakCount == 10) |> 
  unnest(PeakData) |>
  select(-c(Peaks))

Peaks10 <- bind_cols(Peaknm10, PeakAmps10, Peaksd10, .name_repair = "unique") |>
  rename(Amp = estimate...5,
         std.errAmp = std.error...6,
         SD = estimate...7,
         std.errSD = std.error...8)


SpectraMidPeaks <- rbind(Peaks8,Peaks9,Peaks10) %>%
  mutate(PeakVol = Amp *  SD)

# SpectraMidPeaks <- rbind(Peaks7, Peaks8,Peaks9) %>%
#   mutate(PeakVol = Amp *  SD)

rm(Peaks8,Peaks9,Peaks10)
```
select value which is closest to 439 nm
https://stackoverflow.com/questions/43472234/fastest-way-to-find-nearest-value-in-vector

There are ways to select a value based upon the value in another column
work only when chlorophyll peak is on the second position!
```{r ChlNormAmp}
# SpectraMidPeaks |>
#   group_by(ID, PeakCount) %>%
#   mutate(AmpChlNorm = Amp/Amp[2],
#          AmpChlSD = `std.errAmp`/Amp[2],
#          PeakVolChlNorm = PeakVol/PeakVol[2])

SpectraMidPeaksNorm <- SpectraMidPeaks%>% 
  group_by(ID, PeakCount) %>%
  mutate(AmpChlNorm = Amp/Amp[2],
         AmpChlSD = `std.errAmp`/Amp[2],
         PeakVolChlNorm = PeakVol/PeakVol[2]) %>% #normalized to 440 (second peak)
  filter(PeakVolChlNorm >=0) %>% #deleting the negative values  (negative peaks)
  ungroup()
```


```{r save SpectraMidPeaks}
# saveRDS(SpectraMidPeaks, file = file.path(OutPath, paste(Project, "SpectraMidPeaksCCAchosen", ".Rds",sep = "_"),fsep = .Platform$file.sep))

# saveRDS(SpectraMidPeaks, file.path(DataOut, paste(Project, "SpectraMidPeaksCCAchosen.Rds", sep = "_"), fsep = .Platform$file.sep))

```

Adding the metadata catalog

Load Multiculti catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

MetaData <- read_sheet("https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0") %>%
  drop_na(WL) %>%
  mutate(WL = unlist(WL))

as.data.frame(MetaData)
MetaData <- MetaData %>%
   mutate(ExpDate = ymd(ExpDate),
          ExpEndDate = ymd_hms(`ExpEndDate`))
```

Filter multiculti catalog for SySl CCA paper
```{r}
# colnames(MetaData)
MetaData <- MetaData %>%
summarize(Run, ID, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, Tube, O2, WL, LightShape) %>%
  filter(Strain == "BA127R" | Strain == "BA77G") %>%
  filter(WL == 530 | WL == 660) %>%
  filter(Par_ue == 60 | Par_ue == 300) %>%
  filter(Run == 70) %>% 

  mutate(PhotonDose =(Par_ue/2)*Photoperiod*3600) %>% #per day
  mutate(PhotonDose =PhotonDose/24) #per h
  

```

# Merge OLISSpectra with MetaData
```{r}
# 
SpectraMidPeaksMeta <- MetaData %>%
  left_join(., SpectraMidPeaksNorm, by = c("ID" = "ID"))

```

Adding the pigments names
```{r}
  SpectraMidPeaksMeta$Pigment = SpectraMidPeaksMeta$Photoperiod

  SpectraMidPeaksMeta_414 <- SpectraMidPeaksMeta %>%
  filter(nm == 414 | nm == 415) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"DV-Pheo_a"))  

  SpectraMidPeaksMeta_440 <- SpectraMidPeaksMeta %>%
  filter(nm == 439 | nm == 440) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"DV-Chl_a")) 
  
  SpectraMidPeaksMeta_466 <- SpectraMidPeaksMeta %>%
  filter(nm == 465 | nm == 466 | nm == 467) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"Zea+Bcar+ech"))
 
  SpectraMidPeaksMeta_500 <- SpectraMidPeaksMeta %>%
  filter(nm == 496 | nm == 497 | nm == 498 | nm == 500) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"PUB-rich PE or PC")) 
  
  SpectraMidPeaksMeta_546 <- SpectraMidPeaksMeta %>%
  filter(nm == 546 | nm == 547) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"PEB-rich PE")) #?
 
  SpectraMidPeaksMeta_570 <- SpectraMidPeaksMeta %>%
  filter(nm == 569 | nm == 570) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"PEB-rich PE"))  
  
  SpectraMidPeaksMeta_580 <- SpectraMidPeaksMeta %>%
  filter(nm == 578 | nm == 579 | nm == 582) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"PCB-rich PC")) #PEC?
  
  SpectraMidPeaksMeta_620 <- SpectraMidPeaksMeta %>%
  filter(nm == 619 | nm == 622) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"PCB-rich PC"))
  
  SpectraMidPeaksMeta_625 <- SpectraMidPeaksMeta %>%
  filter(nm == 625 | nm == 627 | nm == 629 | nm == 631) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"APC")) #DV-chl a?
  
  SpectraMidPeaksMeta_640 <- SpectraMidPeaksMeta %>%
  filter(nm == 639) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"APC"))
  
  SpectraMidPeaksMeta_680 <- SpectraMidPeaksMeta %>%
  filter(nm == 681| nm == 682) %>% 
  mutate(Pigment=case_when(Pigment =="12"~"DV-chl a"))
  
  
  SpectraMidPeaksMeta <- rbind(SpectraMidPeaksMeta_414, SpectraMidPeaksMeta_440, SpectraMidPeaksMeta_466, SpectraMidPeaksMeta_500, SpectraMidPeaksMeta_546, SpectraMidPeaksMeta_570, SpectraMidPeaksMeta_580, SpectraMidPeaksMeta_620, SpectraMidPeaksMeta_625, SpectraMidPeaksMeta_640, SpectraMidPeaksMeta_680)
 
  rm(SpectraMidPeaksMeta_414, SpectraMidPeaksMeta_440, SpectraMidPeaksMeta_466, SpectraMidPeaksMeta_500, SpectraMidPeaksMeta_546, SpectraMidPeaksMeta_570, SpectraMidPeaksMeta_580, SpectraMidPeaksMeta_620, SpectraMidPeaksMeta_625, SpectraMidPeaksMeta_640, SpectraMidPeaksMeta_680)

```


Combine nm peaks
```{r}

#414 - DV-Pheo_a
SpectraMidPeaksMeta415 <- SpectraMidPeaksMeta %>% 
  filter(nm == 415) %>% 
  mutate(nm2=case_when(nm =="415"~"414")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#440 - DV-Chl_a
SpectraMidPeaksMeta440 <- SpectraMidPeaksMeta %>% 
  filter(nm == 439) %>% 
  mutate(nm2=case_when(nm =="439"~"440")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#466 - Zea+Bcar+ech
SpectraMidPeaksMeta466 <- SpectraMidPeaksMeta %>% 
  filter(nm == 465) %>% 
  mutate(nm2=case_when(nm =="465"~"466")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaksMeta466_2 <- SpectraMidPeaksMeta %>% 
  filter(nm == 467) %>% 
  mutate(nm2=case_when(nm =="467"~"466")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#500 - PUB-rich PE or PC
SpectraMidPeaksMeta500 <- SpectraMidPeaksMeta %>% 
  filter(nm == 496) %>% 
  mutate(nm2=case_when(nm =="496"~"500")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaksMeta500_2 <- SpectraMidPeaksMeta %>% 
  filter(nm == 497) %>% 
  mutate(nm2=case_when(nm =="497"~"500")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaksMeta500_3 <- SpectraMidPeaksMeta %>% 
  filter(nm == 498) %>% 
  mutate(nm2=case_when(nm =="498"~"500")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#547 - PEB-rich PE
SpectraMidPeaksMeta547 <- SpectraMidPeaksMeta %>% 
  filter(nm == 546) %>% 
  mutate(nm2=case_when(nm =="546"~"547")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#570 - PEB-rich PE
SpectraMidPeaksMeta570 <- SpectraMidPeaksMeta %>% 
  filter(nm == 569) %>% 
  mutate(nm2=case_when(nm =="569"~"570")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#580 - PCB-rich PC
SpectraMidPeaksMeta580 <- SpectraMidPeaksMeta %>% 
  filter(nm == 578) %>% 
  mutate(nm2=case_when(nm =="578"~"580")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaksMeta580_2 <- SpectraMidPeaksMeta %>% 
  filter(nm == 579) %>% 
  mutate(nm2=case_when(nm =="579"~"580")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaksMeta580_3 <- SpectraMidPeaksMeta %>% 
  filter(nm == 582) %>% 
  mutate(nm2=case_when(nm =="582"~"580")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#619 - PCB-rich PC
SpectraMidPeaksMeta619 <- SpectraMidPeaksMeta %>% 
  filter(nm == 621) %>% 
  mutate(nm2=case_when(nm =="621"~"619")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaksMeta619_2 <- SpectraMidPeaksMeta %>% 
  filter(nm == 622) %>% 
  mutate(nm2=case_when(nm =="622"~"619")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#631 - APC
SpectraMidPeaksMeta631 <- SpectraMidPeaksMeta %>% 
  filter(nm == 625) %>% 
  mutate(nm2=case_when(nm =="625"~"631")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaksMeta631_2 <- SpectraMidPeaksMeta %>% 
  filter(nm == 627) %>% 
  mutate(nm2=case_when(nm =="627"~"631")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaksMeta631_3 <- SpectraMidPeaksMeta %>% 
  filter(nm == 629) %>% 
  mutate(nm2=case_when(nm =="629"~"631")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#639 - APC
#680 - DV-chl a
SpectraMidPeaksMeta680 <- SpectraMidPeaksMeta %>% 
  filter(nm == 681) %>% 
  mutate(nm2=case_when(nm =="681"~"680")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaksMeta680_2 <- SpectraMidPeaksMeta %>% 
  filter(nm == 682) %>% 
  mutate(nm2=case_when(nm =="682"~"680")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)

SpectraMidPeaksMetaunfilter <- SpectraMidPeaksMeta %>% 
  filter(nm == 414| nm == 440| nm==466| nm==500| nm==547| nm==570| nm==580| nm==619| nm==631| nm==639| nm==680)


SpectraMidPeaksMeta <-rbind(SpectraMidPeaksMeta415, SpectraMidPeaksMeta440, SpectraMidPeaksMeta466, SpectraMidPeaksMeta466_2, SpectraMidPeaksMeta500, SpectraMidPeaksMeta500_2, SpectraMidPeaksMeta500_3, SpectraMidPeaksMeta547, SpectraMidPeaksMeta570, SpectraMidPeaksMeta580, SpectraMidPeaksMeta580_2, SpectraMidPeaksMeta580_3,  SpectraMidPeaksMeta619, SpectraMidPeaksMeta619_2, SpectraMidPeaksMeta631, SpectraMidPeaksMeta631_2, SpectraMidPeaksMeta631_3,SpectraMidPeaksMeta680, SpectraMidPeaksMeta680_2,  SpectraMidPeaksMetaunfilter) 


rm(SpectraMidPeaksMeta415, SpectraMidPeaksMeta440, SpectraMidPeaksMeta466, SpectraMidPeaksMeta466_2, SpectraMidPeaksMeta500, SpectraMidPeaksMeta500_2, SpectraMidPeaksMeta500_3, SpectraMidPeaksMeta547, SpectraMidPeaksMeta570, SpectraMidPeaksMeta580, SpectraMidPeaksMeta580_2, SpectraMidPeaksMeta580_3,  SpectraMidPeaksMeta619, SpectraMidPeaksMeta619_2, SpectraMidPeaksMeta631, SpectraMidPeaksMeta631_2, SpectraMidPeaksMeta631_3,SpectraMidPeaksMeta680, SpectraMidPeaksMeta680_2,  SpectraMidPeaksMetaunfilter) 
```


```{r save SpectraMidPeaks}

saveRDS(SpectraMidPeaksMeta, file.path(DataOut, paste(Project, "SpectraMidPeaksMetaCCAchosen.Rds", sep = "_"), fsep = .Platform$file.sep))

```

```{r}
#414 - DV-chl a or DV-pheophytin a (412nm)
#440 - DV-chl a
#466 - car (Zea + Bcar + echinenone)
#500 - PUB-rich PE or PC

#547 - PUB-rich PE or PC
#569 - PEB-rich PE

#582 - phycoerythrocyanin ((PEC)) or DV-chl a or bacteriochlorophyll
#619 - PCB-rich PC
#625 - DV-chl a
#631 - 
#639 - APC? or chb(!)
#680 - DV-chl a


#PC - 414, 440, 446, 500, 582, 620, 639, 680

```

```{r}
SpectraMidPeaksMeta <- SpectraMidPeaksMeta %>%
  mutate(nm = as.integer(nm))

SpectraFilterMidClean <- SpectraFilterMid %>%
  select(-c(PrimaryOperator, Description, Motivation, doi, Media, MediaDate, Well,Plate, EndDate, Salinity, N2, CO2, Ar, Source, SourceSalinity, FinalpH, Inoc_mL, Media_mL, ExpCul, InocpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, "...44", "...45", OptodeCh, Project, MC, O2_Category, Cdatetime, Temp_c, Tube, Optode, ProjectID, "Calculated_µmolPhotons_m-2d-1", ExpStartTime))

#colnames(SpectraFilterMidClean)

SpectraMidPeaksMetaCombine <- SpectraFilterMidClean %>%
  left_join(., SpectraMidPeaksMeta, by = c("Run"= "Run", "ID" = "ID", "Strain" = "Strain", "InnocDate" = "InnocDate", "ExpDate" = "ExpDate", "Par_ue" = "Par_ue", "Photoperiod" = "Photoperiod", "O2" = "O2", "WL" = "WL", "LightShape" = "LightShape", "E_days" = "E_days", "nm" = "nm"))

#colnames(SpectraMidPeaksMetaCombine)


SpectraMidPeaksMetaCombine <- SpectraMidPeaksMetaCombine %>% 
  select(-c(FirstDer, SecDer, SecDerNeg, Tube)) 


```



```{r}
# SpectraFilterMid_nm <- SpectraFilterMid %>% 
#   select(nm) %>% 
#   unique() %>% 
#   filter(nm<=700) 
#   
# SpectraMidPeaksMetaCombine <- SpectraMidPeaksMetaCombine %>% 
#   mutate(nm = as.integer(nm))
# 
# SpectraMidPeaksMetaCombineAll <- SpectraFilterMid_nm %>%
#   left_join(., SpectraMidPeaksMetaCombine, by = c("nm" = "nm"))


```
left join with metadata again
```{r}

# SpectraFilterMidClean <- SpectraFilterMid %>% 
#   select(-c(PrimaryOperator, Description, Motivation, doi, Media, MediaDate, Well,Plate, EndDate, Salinity, N2, CO2, Ar, Source, SourceSalinity, FinalpH, Inoc_mL, Media_mL, ExpCul, InocpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, "...44", "...45", OptodeCh, Project, MC, O2_Category, Cdatetime, Temp_c, Tube, Optode, ProjectID))


```

```{r}
# 
# SpectraMidPeaksMetaCombineAll2 <- SpectraMidPeaksMetaCombineAll %>%
#   left_join(., SpectraFilterMidClean, by = c("ID" = "ID"))

```



#plot with combine peaks - error
```{r fig.height = 6, fig.width = 8}

Xvar = sym("nm")
Yvar = sym("AbsBase")

Groupvar1 = sym("ID")
Groupvar2 = sym("WL")
Groupvar3 = sym("Strain")
Groupvar4 = sym("Par_ue")
Groupvar5 = sym("Photoperiod")
TargetStrain = sym("BA127R, BA77G")

#add sec.axis labels to put variable names on facets
SpectraMidPeaksMetaCombine %>%
  ggplot() +
  geom_point(aes(x = !!Xvar, y = !!Yvar), size = 0.1) +
  geom_line(aes(x = !!Xvar, y = SecDerAv * 50)) +
  geom_point(aes(x = !!Xvar, y = Peaks * 50), colour = "darkred", size = 0.2) +
  geom_text(aes(x = !!Xvar, y = Peaks * 50, label = nm), angle = 45, colour = "darkred", nudge_x = -0.01, nudge_y = -0.001, size = 2) +
  #facet_grid(cols = vars(!!Groupvar3), rows = vars(!!Groupvar4, !!Groupvar5)) +
  # scale_x_continuous(sec.axis = sec_axis(~ . , name = Groupvar3, breaks = NULL, labels = NULL)) +
  # scale_y_continuous(sec.axis = sec_axis(~ . , name = paste(Groupvar4, Groupvar5, sep = ", "), breaks = NULL, labels = NULL)) +
  labs(y = "Absorbance", x = "Wavelength (nm)") +
    ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, WL = label_both, Par_ue = label_both, Strain = label_value)) +
theme_bw() +
      theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.direction="horizontal",
        legend.position = c(0.08,0.97),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text.align = 0,
        #legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.3, 'cm'),
        legend.text = element_text(size=10))

```




Normalization at 440 
```{r}

Absorbance440 <- SpectraFilterMid %>%
  filter(nm == 440) %>%
  mutate(Abs440 = Absorbance) %>%
  select(ID, Strain, Abs440, Par_ue, Photoperiod, E_days)

SpectraFilterMid440 <- SpectraFilterMid %>%
  left_join(., Absorbance440) %>%
  mutate(AbsNorm440 = Absorbance / Abs440)

SpectraFilterMid440 <- SpectraFilterMid440 %>%
group_by(ID, E_days, Par_ue, Photoperiod) %>%
  mutate(SumAbNorm = sum(AbsNorm440)) %>%
ungroup()

```

```{r SpectraFilterMid440_TestPlot}

# SpectraFilterMid440 |>
#   ggplot() +
#   geom_point(aes(x = nm, y = AbsNorm440))
```


# Use 2nd Derivative to find peak positions Normalization 440

```{r second derivative}
#https://stackoverflow.com/questions/49762128/rolling-regression-by-group-in-the-tidyverse?noredirect=1&lq=1

#function to generate slope from ratio of covariance to variance
slope <- . %>% { cov(.[, 2], .[, 1]) / var(.[, 2])}

#range rolling window variables; be careful with different data sets
NmperRow <- ((SpectraFilterMid440$nm[length(SpectraFilterMid440$nm)]- SpectraFilterMid440$nm[1]) +1)/nrow(SpectraFilterMid440)
FirstRange <- 10
SecondRange <- 10

# SpectraFilterMid <- SpectraFilterMid  |>
#   group_by(Filename) |>
#   mutate(FirstDer = rollapplyr(cbind(AbsBase, nm), FirstRange, slope, by.column = FALSE, align = 'center', fill = NA)) |>
#   mutate(SecDer = rollapplyr(cbind(FirstDer, nm), SecondRange, slope, by.column = FALSE, align = 'center', fill = NA)) |>
#   ungroup()

SpectraFilterMid440 <- SpectraFilterMid440  |>
  group_by(ID, E_days) |>
  mutate(FirstDer = rollapplyr(cbind(AbsNorm440, nm), FirstRange, slope, by.column = FALSE, align = 'center', fill = NA)) |>
  mutate(SecDer = rollapplyr(cbind(FirstDer, nm), SecondRange, slope, by.column = FALSE, align = 'center', fill = NA)) |>
  ungroup()

#average 2nd derivative across spectra
#Decide whether to pool all data from Strain x WL, or to pool by Strain x WL x Par_ue
#, Par_ue,
SpectraFilterMid440 <- SpectraFilterMid440 |>
  group_by(nm, Strain, WL, Par_ue, Photoperiod) |>
  mutate(SecDerAv = mean(SecDer)) |>
  ungroup() |>
  mutate(SecDerNeg = if_else(SecDerAv < 0, SecDerAv, NA_real_),
         Peaks = if_else(SecDerNeg < lag(SecDerNeg, n = 1) & SecDerNeg < lead(SecDerNeg, n = 1), SecDerNeg, NA_real_))

```



Normalization plot
```{r fig.height = 6, fig.width = 8}

Xvar = sym("nm")
Yvar = sym("AbsNorm440")

Groupvar1 = sym("ID")
Groupvar2 = sym("WL")
Groupvar3 = sym("Strain")
Groupvar4 = sym("Par_ue")
Groupvar5 = sym("Photoperiod")
TargetStrain = sym("BA127R, BA77G")

#add sec.axis labels to put variable names on facets
SpectraFilterMid440 |> 
  filter(WL == 660) %>% 
  ggplot() +
  geom_point(aes(x = !!Xvar, y = !!Yvar), size = 0.1) + 
  geom_line(aes(x = !!Xvar, y = SecDerAv * 50)) +
  geom_point(aes(x = !!Xvar, y = Peaks * 50), colour = "darkred", size = 0.2) +
  geom_text(aes(x = !!Xvar, y = Peaks * 50, label = nm), angle = 45, colour = "darkred", nudge_x = -0.01, nudge_y = -0.001, size = 3) + 
  #facet_grid(cols = vars(!!Groupvar3), rows = vars(!!Groupvar4, !!Groupvar5)) +
  # scale_x_continuous(sec.axis = sec_axis(~ . , name = Groupvar3, breaks = NULL, labels = NULL)) +
  # scale_y_continuous(sec.axis = sec_axis(~ . , name = paste(Groupvar4, Groupvar5, sep = ", "), breaks = NULL, labels = NULL)) +
  scale_y_continuous(breaks=seq(0, 1, by = 0.5)) +
  coord_cartesian(ylim = c (-1, 1.5)) +
  labs(y = "Normalized absorbance", x = "Wavelength (nm)") +
    ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, WL = label_both, Par_ue = label_both, Strain = label_value)) +
theme_bw() +
      theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.direction="horizontal",
        legend.position = c(0.08,0.97),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text.align = 0,
        #legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.3, 'cm'),
        legend.text = element_text(size=10))

```
Combine peaks to get nice plot
```{r}

SpectraFilterMid440Clean <- SpectraFilterMid440 %>% 
  select(-c(PrimaryOperator, Description, Motivation, doi, Media, MediaDate, Well,Plate, EndDate, Salinity, N2, CO2, Ar, Source, SourceSalinity, FinalpH, Inoc_mL, Media_mL, ExpCul, InocpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, "...44", "...45", OptodeCh, Project, MC, O2_Category, Cdatetime, Temp_c, Tube, Optode, ProjectID))
  #colnames(SpectraFilterMid440Clean)

  
```


```{r}


#414
SpectraMidPeaks440Meta415 <- SpectraFilterMid440Clean %>% 
  filter(nm == 415) %>% 
  mutate(nm2=case_when(nm =="415"~"414")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#440
SpectraMidPeaks440Meta440 <- SpectraFilterMid440Clean %>% 
  filter(nm == 439) %>% 
  mutate(nm2=case_when(nm =="439"~"440")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#466
SpectraMidPeaks440Meta466 <- SpectraFilterMid440Clean %>% 
  filter(nm == 465) %>% 
  mutate(nm2=case_when(nm =="465"~"466")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaks440Meta466_2 <- SpectraFilterMid440Clean %>% 
  filter(nm == 467) %>% 
  mutate(nm2=case_when(nm =="467"~"466")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#500
SpectraMidPeaks440Meta500 <- SpectraFilterMid440Clean %>% 
  filter(nm == 496) %>% 
  mutate(nm2=case_when(nm =="496"~"500")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaks440Meta500_2 <- SpectraFilterMid440Clean %>% 
  filter(nm == 497) %>% 
  mutate(nm2=case_when(nm =="497"~"500")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaks440Meta500_3 <- SpectraFilterMid440Clean %>% 
  filter(nm == 498) %>% 
  mutate(nm2=case_when(nm =="498"~"500")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#547
SpectraMidPeaks440Meta547 <- SpectraFilterMid440Clean %>% 
  filter(nm == 546) %>% 
  mutate(nm2=case_when(nm =="546"~"547")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#569
#580
SpectraMidPeaks440Meta582 <- SpectraFilterMid440Clean %>% 
  filter(nm == 578) %>% 
  mutate(nm2=case_when(nm =="578"~"580")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaks440Meta582_2 <- SpectraFilterMid440Clean %>% 
  filter(nm == 579) %>% 
  mutate(nm2=case_when(nm =="579"~"580")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaks440Meta582_3 <- SpectraFilterMid440Clean %>% 
  filter(nm == 582) %>% 
  mutate(nm2=case_when(nm =="582"~"580")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#620
SpectraMidPeaks440Meta619 <- SpectraFilterMid440Clean %>% 
  filter(nm == 621) %>% 
  mutate(nm2=case_when(nm =="621"~"620")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaks440Meta619_2 <- SpectraFilterMid440Clean %>% 
  filter(nm == 622) %>% 
  mutate(nm2=case_when(nm =="622"~"620")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaks440Meta619_3 <- SpectraFilterMid440Clean %>% 
  filter(nm == 619) %>% 
  mutate(nm2=case_when(nm =="619"~"620")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#625
#631
SpectraMidPeaks440Meta631 <- SpectraFilterMid440Clean %>% 
  filter(nm == 629) %>% 
  mutate(nm2=case_when(nm =="629"~"631")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
#639
#680
SpectraMidPeaks440Meta680 <- SpectraFilterMid440Clean %>% 
  filter(nm == 681) %>% 
  mutate(nm2=case_when(nm =="681"~"680")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)
SpectraMidPeaks440Meta680_2 <- SpectraFilterMid440Clean %>% 
  filter(nm == 682) %>% 
  mutate(nm2=case_when(nm =="682"~"680")) %>% 
  select(-c(nm)) %>% 
  rename(nm = nm2)

SpectraMidPeaks440Metaunfilter <- SpectraFilterMid440Clean %>% 
  filter(nm == 414| nm == 440| nm==466| nm==500| nm==547| nm==569| nm==580| nm==620| nm==625| nm==631| nm==639| nm==680)


SpectraFilterMid440Combine <-rbind(SpectraMidPeaks440Meta415, SpectraMidPeaks440Meta440, SpectraMidPeaks440Meta466, SpectraMidPeaks440Meta466_2, SpectraMidPeaks440Meta500, SpectraMidPeaks440Meta500_2, SpectraMidPeaks440Meta500_3, SpectraMidPeaks440Meta547, SpectraMidPeaks440Meta582, SpectraMidPeaks440Meta582_2,SpectraMidPeaks440Meta582_3, SpectraMidPeaks440Meta619, SpectraMidPeaks440Meta619_2, SpectraMidPeaks440Meta619_3, SpectraMidPeaks440Meta631, SpectraMidPeaks440Meta680, SpectraMidPeaks440Meta680_2, SpectraMidPeaks440Metaunfilter) 

```


# Merge OLISSpectra with MetaData
```{r}
# 
SpectraFilterMid440Combine <- SpectraFilterMid440Combine %>% 
  rename(nm_peak = nm)

#colnames(SpectraFilterMid440Combine)

SpectraFilterMid440CombineAll <- SpectraFilterMid440Clean %>%
  full_join(., SpectraFilterMid440Combine, by = c("Run" = "Run", "ID" = "ID", "Strain" = "Strain", "InnocDate" = "InnocDate", "ExpDate" = "ExpDate", "ExpStartTime" = "ExpStartTime", "Par_ue" = "Par_ue", "Photoperiod" = "Photoperiod", "Calculated_µmolPhotons_m-2d-1" = "Calculated_µmolPhotons_m-2d-1", "O2" = "O2", "WL" = "WL", "LightShape" = "LightShape", "ExpEndDate" = "ExpEndDate", "Filename" = "Filename", "SpectraDate" = "SpectraDate", "Range" = "Range",  "Absorbance" = "Absorbance", "E_days" = "E_days", "AbsBase" = "AbsBase", "FirstDer" = "FirstDer", "SecDer" = "SecDer", "SecDerAv" = "SecDerAv", "SecDerNeg" = "SecDerNeg", "Peaks" = "Peaks", "Abs440" = "Abs440", "AbsNorm440" = "AbsNorm440", "SumAbNorm" = "SumAbNorm"))

```



Normalization plot
```{r fig.height = 6, fig.width = 8}

Xvar = sym("nm")
Yvar = sym("AbsNorm440")

Groupvar1 = sym("ID")
Groupvar2 = sym("WL")
Groupvar3 = sym("Strain")
Groupvar4 = sym("Par_ue")
Groupvar5 = sym("Photoperiod")
TargetStrain = sym("BA127R, BA77G")

#add sec.axis labels to put variable names on facets
SpectraFilterMid440CombineAll %>%  
  filter(WL == 660) %>% 
  ggplot() +
  geom_point(aes(x = nm, y = AbsNorm440), size = 0.1) + 
  geom_line(aes(x = nm, y = SecDerAv * 50)) +
  geom_point(aes(x = nm_peak, y = Peaks * 50), colour = "darkred", size = 0.2) +
  geom_text(aes(x = nm_peak, y = Peaks * 50), angle = 45, colour = "darkred", nudge_x = -0.01, nudge_y = -0.001, size = 3) + 
    stat_wl_strip(aes(x = nm), ymin = -Inf, ymax = -0.95, alpha = 0.5) + 
  scale_fill_identity() +

  #facet_grid(cols = vars(!!Groupvar3), rows = vars(!!Groupvar4, !!Groupvar5)) +
  # scale_x_continuous(sec.axis = sec_axis(~ . , name = Groupvar3, breaks = NULL, labels = NULL)) +
  # scale_y_continuous(sec.axis = sec_axis(~ . , name = paste(Groupvar4, Groupvar5, sep = ", "), breaks = NULL, labels = NULL)) +
  scale_y_continuous(breaks=seq(0, 1, by = 0.5)) +
  coord_cartesian(ylim = c (-1, 1.5)) +
  labs(y = "Normalized absorbance", x = "Wavelength (nm)") +
    ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, WL = label_both, Par_ue = label_both, Strain = label_value)) +
theme_bw() +
      theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.direction="horizontal",
        legend.position = c(0.08,0.97),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text.align = 0,
        #legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.3, 'cm'),
        legend.text = element_text(size=10))

```

