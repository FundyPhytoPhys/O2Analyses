---
title: "Import OLIS spectral data data"
author: "Douglas A. Campbell, Sylwia Sliwinska-Wilczewska"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

# Import spectral files generated by OLIS spectrophotometer

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

```{r set project variables}
Project <- "PICO"
DataOut <- file.path("..", "ImportedData", "OLIS")

DataIn <- file.path("..", "OLISSpectraCorr", "JLPigments", fsep = .Platform$file.sep)

FileID <- "Smooth"

#MDPicoGoogle <- "https://docs.google.com/spreadsheets/d/1Lerp5u25kzBtaBbnOYElYqUP59cn68gJpxxayhnGdkw/edit#gid=0"

FileEncode <- "UTF-8" 
Delimiter <- ""

HeaderRows <- 0
```


```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)

library(dplyr)
library(magrittr)
library(googledrive)
library(googlesheets4)
library(readxl)

library(ggspectra)
library(ggpubr)
library(caret)
library(viridis)
```

```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c("darkblue", "dodgerblue", "darkgreen", "yellowgreen",  "darkorange")


names(Colours_nm) <- Wavelengths_nm
Colours_nm

```

```{r list available OLIS Files}
OlisFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE)
OlisFiles

#test for duplicate file names
unique(duplicated(OlisFiles))
```


# set up read_delim_plus
```{r}
# #make this more robust to variable file formats
#FileEncode <- "UTF-8"
#Delimiter <- ""
# #.asc files from export from OLIS seem to use spaces as delimiter
# 
#HeaderRows <- 0

read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime))
}

#read.delim_long meant for map over a vector of filepaths to read, convert to long format and tidy the imported data
read.delim_long <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
    mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime)) %>%
 rename(nm = OLIS.3D.ASCII) %>%
  mutate(FirstLastSpec = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_")) %>%
  mutate(SampleNumbers = str_extract_all(FirstLastSpec, "[:digit:][:digit:][:digit:][:digit:]")) %>%
  mutate(FirstSampleNumber = as.numeric(map(SampleNumbers, ~.[[1]]))) %>%
  mutate(LastSampleNumber = as.numeric(map(SampleNumbers, ~.[[2]]))) %>%
  mutate(OperatorID = str_extract(Filename,"[A-Z][a-z][A-Z][a-z]")) %>%
  pivot_longer(cols = starts_with("X"), names_to = "SpectraID", values_to = "Abs") %>%
  mutate(SampleCode = as.numeric(str_remove(SpectraID, "X"))) %>%
  mutate(SampleNumber = SampleCode - min(SampleCode, na.rm = TRUE) + FirstSampleNumber) %>%
  relocate(OperatorID, SampleNumber) %>%
  unite(col = SampleID, OperatorID:SampleNumber, sep = "", remove = FALSE) %>%
  arrange(SampleID, nm) %>%
  relocate(SampleID, nm, Abs) %>%
  mutate(SpectraDate = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
         SpectraDate = str_remove_all(SpectraDate, "_"),
         SpectraDate = str_remove_all(SpectraDate, "/"),
         SpectraDate = ymd(SpectraDate)
  )
}
```


# Import OLISSpectra corrected files
```{r import from specific OLIS corrected file containing multiple spectra}

TargetFile <-  OlisFiles

TargetSpectra <- TargetFile %>% map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows)) %>% 
  pivot_longer(., -c(`OLIS.3D.ASCII`, Filename, Cdatetime), values_to = "Absorbance", names_to = "SampleID") %>%
  filter(!is.na(Absorbance)) %>%
  rename(nm = `OLIS.3D.ASCII`)   
  #separate(col = SampleID, into = c("SampleID", "Replicate"), sep = "_")

TargetSpectraLong <- TargetSpectra %>%
  # rename(nm = OLIS.3D.ASCII) %>%
  separate(col = Filename, into = c("fp1", "fp2", "fp3", "SpectraDate", "Project", "Source", "Range", "Type", "Correction", "Smooth"), sep = "([\\/\\_\\:])", remove = FALSE) 

TargetSpectraLong2 <- TargetSpectraLong %>%
  select(-c(fp1, fp2, fp3, Type, Correction, Smooth, SampleID)) %>% 
  rename(SampleID = Source) %>% 
  mutate(SpectraDate = ymd(`SpectraDate`)) 
```
Spectra divaided by ID (Chig, IrTo1, IrTo2, IrTo3)
```{r}

TargetSpectraChig <- TargetSpectraLong2 %>%
  filter(SampleID == "Chig1001"| SampleID == "Chig1002"| SampleID == "Chig1003"| SampleID == "Chig1004"| SampleID == "Chig1005"| SampleID == "Chig1006"| SampleID == "Chig1007"| SampleID == "Chig1008"| SampleID == "Chig1009"| SampleID == "Chig1010"| SampleID == "Chig1011"| SampleID == "Chig1012"| SampleID == "Chig1013"| SampleID == "Chig1014") %>% 
  mutate(ID=case_when(Project=="CBC"~"Chig")) 
  
TargetSpectraIrToAll <- TargetSpectraLong2 %>%
  filter(SampleID != "Chig1001"& SampleID != "Chig1002"& SampleID != "Chig1003"& SampleID != "Chig1004"& SampleID != "Chig1005"& SampleID != "Chig1006"& SampleID != "Chig1007"& SampleID != "Chig1008"& SampleID != "Chig1009"& SampleID != "Chig1010"& SampleID != "Chig1011"& SampleID != "Chig1012"& SampleID != "Chig1013"& SampleID != "Chig1014") %>% 
  mutate(ID=case_when(Project=="CBC"~"IrTo")) 


TargetSpectraIrTo1 <- TargetSpectraIrToAll %>%
  filter(SampleID == "IrTo1001"| SampleID == "IrTo1002"| SampleID == "IrTo1003"| SampleID == "IrTo1004"| SampleID == "IrTo1005"| SampleID == "IrTo1006") %>% 
  mutate(ID=case_when(Project=="CBC"~"IrTo1"))

TargetSpectraIrTo2 <- TargetSpectraIrToAll %>%
  filter(SampleID == "IrTo2001"| SampleID == "IrTo2002"| SampleID == "IrTo2003"| SampleID == "IrTo2004"| SampleID == "IrTo2005"| SampleID == "IrTo2006") %>% 
  mutate(ID=case_when(Project=="CBC"~"IrTo2"))

TargetSpectraIrTo3 <- TargetSpectraIrToAll %>%
  filter(SampleID == "IrTo3001"| SampleID == "IrTo3002"| SampleID == "IrTo3003"| SampleID == "IrTo3004"| SampleID == "IrTo3005"| SampleID == "IrTo3006") %>% 
  mutate(ID=case_when(Project=="CBC"~"IrTo3"))


TargetSpectraAll <- rbind(TargetSpectraChig, TargetSpectraIrTo1, TargetSpectraIrTo2, TargetSpectraIrTo3)
```

Raw Spectra Plot
```{r fig.height = 6, fig.width = 8, warning = FALSE}
TargetSpectraAllPlot <- TargetSpectraAll %>%
filter(Absorbance >0) %>% 
  ggplot() +
  geom_point(aes(x = nm, y = Absorbance, label = SampleID, colour = as.factor(ID)), size = 0.5) +
  scale_colour_viridis(discrete = TRUE) +
  guides(colour = guide_legend(override.aes = list(size=4))) +
  labs(y = "Absorbance", x = "Wavelength (nm)") +
  ggh4x::facet_nested(cols = vars(ID), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
  theme_bw() +
      theme(panel.grid.minor = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.position = c(0.93,0.90),
        legend.text = element_text(size=10))
TargetSpectraAllPlot

```

I diluted sample 5x for OLIS, thus in this chunk there is "real" absorbance obtained from "filters" method measured using also normal spectrophotometer (do not include aceton/sample ratio before extraction)
```{r}
TargetSpectraReal <- TargetSpectraAll %>% 
mutate(AbsorbanceReal = Absorbance*5)
```

Real Spectra Plot
```{r fig.height = 6, fig.width = 8, warning = FALSE}
TargetSpectraRealPlot <- TargetSpectraReal %>%
filter(Absorbance >0) %>% 
  ggplot() +
  geom_point(aes(x = nm, y = AbsorbanceReal, label = SampleID, colour = as.factor(ID)), size = 0.5) +
  scale_colour_viridis(discrete = TRUE) +
  guides(colour = guide_legend(override.aes = list(size=4))) +
  labs(y = "Absorbance", x = "Wavelength (nm)") +
  # scale_y_continuous(breaks=seq(0, 0.03, by = 0.01)) +
  # coord_cartesian(ylim = c (-0.005, 0.03)) +
  ggh4x::facet_nested(cols = vars(ID), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
  theme_bw() +
      theme(panel.grid.minor = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.position = c(0.93,0.90),
        legend.text = element_text(size=10))
TargetSpectraRealPlot


```

Norm 420 Spectra Plot
```{r fig.height = 6, fig.width = 8, warning = FALSE}


Absorbance440 <- TargetSpectraReal %>%
  filter(nm == 420) %>%
  mutate(Abs440 = Absorbance) %>%
  select(SampleID, Abs440)

OLISSpectraMetaPlot <- TargetSpectraReal %>%
  left_join(., Absorbance440) %>%
  mutate(AbsNorm440 = Absorbance / Abs440) %>%

  filter(Absorbance >0) %>%
  ggplot() +
  geom_point(aes(x = nm, y = AbsNorm440, label = SampleID, colour = as.factor(ID)), size = 0.5) +
  scale_colour_viridis(discrete = TRUE) +
  guides(colour = guide_legend(override.aes = list(size=4))) +
  labs(y = "Normalized absorbance", x = "Wavelength (nm)") +
  ggh4x::facet_nested(cols = vars(ID), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
  theme_bw() +
      theme(panel.grid.minor = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.position = c(0.93,0.90),
        legend.text = element_text(size=10))
OLISSpectraMetaPlot


```

Spectra per month
```{r}
TargetSpectraRealMay <- TargetSpectraReal %>%
  filter(SpectraDate == "2022-05-13" | SpectraDate == "2022-05-19" | SpectraDate == "2022-05-25") %>% 
  mutate(Month=case_when(Project=="CBC"~"May"))
  
TargetSpectraRealJune <- TargetSpectraReal %>%
  filter(SpectraDate == "2022-06-02" | SpectraDate == "2022-06-07" | SpectraDate == "2022-06-16" | SpectraDate == "2022-06-24" | SpectraDate == "2022-06-29") %>% 
  mutate(Month=case_when(Project=="CBC"~"June"))

TargetSpectraRealJuly <- TargetSpectraReal %>%
  filter(SpectraDate == "2022-07-05" | SpectraDate == "2022-07-07" | SpectraDate == "2022-07-12" | SpectraDate == "2022-07-18" | SpectraDate == "2022-07-21" | SpectraDate == "2022-07-22" | SpectraDate == "2022-07-28") %>% 
  mutate(Month=case_when(Project=="CBC"~"July"))

TargetSpectraRealAugust <- TargetSpectraReal %>%
  filter(SpectraDate == "2022-08-02") %>% 
  mutate(Month=case_when(Project=="CBC"~"August"))

TargetSpectraRealMonth <- rbind(TargetSpectraRealMay, TargetSpectraRealJune, TargetSpectraRealJuly, TargetSpectraRealAugust)

```

Months in good order
```{r}

TargetSpectraRealMonth2 <-TargetSpectraRealMonth                            # Replicate data
TargetSpectraRealMonth2$Month <- factor(TargetSpectraRealMonth2$Month,      # Reordering group factor levels
                         levels = c("May", "June", "July", "August"))
```


Real Spectra per month Plot
```{r fig.height = 6, fig.width = 8, warning = FALSE}

TargetSpectraRealMonth2Plot <- TargetSpectraRealMonth2 %>%
filter(Absorbance >0) %>% 
  ggplot() +
  geom_point(aes(x = nm, y = AbsorbanceReal, label = SampleID, colour = as.factor(ID)), size = 0.5, show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size=4))) +
  scale_colour_viridis(discrete = TRUE) +
  labs(y = "Absorbance", x = "Wavelength (nm)") +
  # scale_y_continuous(breaks=seq(0, 0.03, by = 0.01)) +
  # coord_cartesian(ylim = c (-0.005, 0.03)) +
  ggh4x::facet_nested(cols = vars(ID), rows = vars(Month), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
  theme_bw() +
      theme(panel.grid.minor = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.position = c(0.93,0.91),
        legend.text = element_text(size=10))
TargetSpectraRealMonth2Plot


```

```{r}
saveRDS(TargetSpectraReal, file.path(DataOut, paste(Project, "OlisSpectraPigments_JL.Rds", sep = "_"), fsep = .Platform$file.sep))
```
