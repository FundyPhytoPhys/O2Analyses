---
title: "Import OLIS spectral data data"
author: "Douglas A. Campbell, Sylwia Sliwinska-Wilczewska, Sarah Gore, Adrian Kryk"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

# Import spectral files generated by OLIS spectrophotometer
Subtract media baseline spectra
Normalize spectra to peak absorbance
Calculate difference between 2 and 250 uM O2
Calculate second derivative spectra

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

```{r set project variables}
Project <- "PICO"
Run <- "O2Analyses"

DataOut <- file.path("..", "Data", "ProcessedData", fsep = .Platform$file.sep)

DataIn <- file.path("..", "Data", "RawData", "OLIS", fsep = .Platform$file.sep)

FileID <- ".txt"

Catalog <- "https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0"

ChlTurner <- "https://docs.google.com/spreadsheets/d/13mQm0B3siS65UuGjNdzvpHFomfuwn6aAg7dBoq1IqrM/edit#gid=0"

FileEncode <- "UTF-8" 
Delimiter <- ""

HeaderRows <- 0
```


```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(broom)
#library(OneR)
library(zoo)
#library(strucchange)

library(googledrive)
library(googlesheets4)
library(readxl)

library(ggspectra)
library(ggpubr)
library(caret)
library(photobiologyWavebands)
```

```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c(w_length2rgb(Wavelengths_nm[1]), w_length2rgb(Wavelengths_nm[2]), w_length2rgb(Wavelengths_nm[3]), w_length2rgb(Wavelengths_nm[4]), w_length2rgb(Wavelengths_nm[5]))

names(Colours_nm) <- Wavelengths_nm
Colours_nm

```

For SySl files 'baseline' in filename means baseline spectra already subtracted within OLIS software.
This was not universallly true across all projects; be careful.
For SySl files 'raw' means spectra of undiluted culture; other spectra are 1 or 4 ml culture + 8 or 4 ml media.

Ideally: we want to read and tidy some user-selected set of files taken from multiple dates

```{r list available OLIS Files}
OlisFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE)
OlisFiles

#test for duplicate file names
unique(duplicated(OlisFiles))
```


# set up read_delim_plus
```{r}
# #make this more robust to variable file formats
#FileEncode <- "UTF-8"
#Delimiter <- ""
# #.asc files from export from OLIS seem to use spaces as delimiter
# 
#HeaderRows <- 0

read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(file = flnm, header = FALSE, fileEncoding = filencode, sep = delimiter,  skip = headerrows,  row.names = NULL) %>%
     mutate(Filename = flnm)
}

#header = TRUE,

#read.delim_long meant for map over a vector of filepaths to read, convert to long format and tidy the imported data
# read.delim_long <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
#     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime)) %>%
#  rename(nm = OLIS.3D.ASCII) %>%
#   mutate(FirstLastSpec = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_")) %>%
#   mutate(SampleNumbers = str_extract_all(FirstLastSpec, "[:digit:][:digit:][:digit:][:digit:]")) %>%
#   mutate(FirstSampleNumber = as.numeric(map(SampleNumbers, ~.[[1]]))) %>%
#   mutate(LastSampleNumber = as.numeric(map(SampleNumbers, ~.[[2]]))) %>%
#   mutate(OperatorID = str_extract(Filename,"[A-Z][a-z][A-Z][a-z]")) %>%
#   pivot_longer(cols = starts_with("X"), names_to = "SpectraID", values_to = "Abs") %>%
#   mutate(SampleCode = as.numeric(str_remove(SpectraID, "X"))) %>%
#   mutate(SampleNumber = SampleCode - min(SampleCode, na.rm = TRUE) + FirstSampleNumber) %>%
#   relocate(OperatorID, SampleNumber) %>%
#   unite(col = SampleID, OperatorID:SampleNumber, sep = "", remove = FALSE) %>%
#   arrange(SampleID, nm) %>%
#   relocate(SampleID, nm, Abs) %>%
#   mutate(SpectraDate = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
#          SpectraDate = str_remove_all(SpectraDate, "_"),
#          SpectraDate = str_remove_all(SpectraDate, "/"),
#          SpectraDate = ymd(SpectraDate)
#   )
# }
```


# Import OLIS files
```{r importspecific OLIS file}

Spectra <- OlisFiles |> 
  map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows)) |>
  rename(nm = V1,
         A = V2) |>
  mutate(Filename = str_remove(string = Filename, pattern = "../Data/RawData/OLIS/")) |>
  mutate(Filename = str_remove(string = Filename, pattern = ".txt")) |>
    separate(col = Filename, into = c("Project", "DateTime", "ID", "O2_uM"), sep = "([\\/\\_\\:])", remove = FALSE) |>
  mutate(DateTime = lubridate::ymd_hm(DateTime))

  
Spectra %>%
  ggplot() +
  geom_point(aes(x = nm, y = A)) +
  facet_grid(rows = vars(ID), cols = vars(O2_uM)) +
  theme_bw()
```

# Subtract baseline
```{r subtract baseline}
Baseline <- Spectra |>
  filter(ID == "Pro99")

Spectra <- Spectra |>
  mutate(ABase = A - Baseline$A)  |>
  group_by(ID, O2_uM) |>
  mutate(ANorm = ABase/max(ABase)) |>
  ungroup()



Spectra |>
  ggplot() +
  geom_point(aes(x = nm, y = ABase)) +
  facet_grid(rows = vars(ID), cols = vars(O2_uM)) +
  theme_bw()

Spectra <- Spectra |>
  filter(ID != "Pro99")

Spectra |>
  ggplot() +
  geom_point(aes(x = nm, y = ABase)) +
  facet_grid(rows = vars(ID), cols = vars(O2_uM)) +
  theme_bw()

Spectra |>
  ggplot() +
  geom_point(aes(x = nm, y = ANorm)) +
  facet_grid(rows = vars(ID), cols = vars(O2_uM)) +
  theme_bw()

```

# 2nd derivative spectra to detect small shifts in absorbance
```{r second derivative}
#https://stackoverflow.com/questions/49762128/rolling-regression-by-group-in-the-tidyverse?noredirect=1&lq=1

#function to generate slope from ratio of covariance to variance
 slope <- . %>% { cov(.[, 2], .[, 1]) / var(.[, 2])}
 
#range rolling window variables; be careful with different data sets
 NmperRow <- ((Baseline$nm[length(Baseline$nm)]- Baseline$nm[1]) +1)/nrow(Baseline)

FirstRange <- 10
SecondRange <- 10

Spectra <- Spectra %>%
  group_by(Filename) %>%
  mutate(FirstDeriv = rollapplyr(cbind(ANorm, nm), FirstRange, slope, by.column = FALSE, align = 'right', fill = NA)) %>%
  mutate(SecondDeriv = rollapplyr(cbind(FirstDeriv, nm), SecondRange, slope, by.column = FALSE, align = 'right', fill = NA)) %>%
     ungroup()


# 
# #different approach
# olis_spectra <- olis_spectra %>%
#   group_by(filename) %>%
#   mutate(diffnm = nm - lag(nm, n =  FirstRange),
#          diffAbs750_0 = Abs750_0 - lag(Abs750_0, n = FirstRange),
#          dAdnm = diffAbs750_0/diffnm) %>%
#   mutate(SecondDriveAlt = dAdnm/FirstRange) %>%
#   ungroup()
# ```
# 
# 
```

```{r second deriv plots}
Spectra |>
  ggplot() +
  geom_point(aes(x = nm, y = SecondDeriv)) +
  facet_grid(rows = vars(ID), cols = vars(O2_uM)) +
  theme_bw()
```


# Pivot 2 and 250 ÂµM O2 data into separate columns
```{r uM O2 separate columns}
SpectraWide <- Spectra |>
  pivot_wider(id_cols = c(nm, Project, ID), names_from = c(O2_uM), values_from = c(Filename, A, ABase, ANorm, FirstDeriv, SecondDeriv))


SpectraWide |>
  ggplot() +
  geom_point(aes(x = nm, y = ABase_2)) +
  geom_point(aes(x = nm, y = ABase_250), colour = "red") +
  facet_grid(rows = vars(ID)) +
  theme_bw()
  
SpectraWide |>
  ggplot() +
  geom_point(aes(x = nm, y = SecondDeriv_2)) +
  geom_point(aes(x = nm, y = SecondDeriv_250), colour = "red") +
  facet_grid(rows = vars(ID)) +
  theme_bw()

SpectraWide |>
  ggplot() +
  geom_line(aes(x = nm, y = SecondDeriv_2), size = 0.5) +
  geom_line(aes(x = nm, y = SecondDeriv_250), size = 0.1, colour = "red") +
  facet_grid(cols = vars(ID)) +
  coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()

```


# Difference spectra
```{r difference spectra}

SpectraWide <- SpectraWide |>
  mutate(A2sub250 = ANorm_2 - ANorm_250)

SpectraWide |>
  ggplot() +
  geom_point(aes(x = nm, y = A2sub250 * 10)) +
  geom_point(aes(x = nm, y = ABase_2), colour = "red") +
  facet_grid(rows = vars(ID)) +
  theme_bw()
```


Load Multiculti catalog and ChlTurner
```{r load multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

# imagine this is the URL or ID of a Sheet readable by anyone (with a link)
# MultiCulti metadata
MetaData <- read_sheet(Catalog)%>%
  # read_sheet has an annoying "feature" to set the type of columns it can't parse to a list.
  # ggplot/dplyr doesn't like working with a dataframe of lists.
  # In this case WL is set to a list since some values are numbers, some are strings, some are blank.
  # To fix this, first drop all rows missing WL, then unlist.
  # Must first drop NA rows since unlist will collapse NULL lists, then the unlisted WL is a shorter length than original WL column, which mutate doesn't like.
  drop_na(WL) %>%
  mutate(WL = unlist(WL))

as.data.frame(MetaData)

MetaData <- MetaData %>%
   mutate(ExpDate = lubridate::ymd(ExpDate),
          ExpEndDate = lubridate::ymd_hms(`ExpEndDate`))
# find units for chl
ChlData <- read_sheet(ChlTurner) |>
  mutate(Chl = as.numeric(Reading_rfu) * as.numeric(Chl_slope) + as.numeric(Chl_intercept))

```


# Merge OLISSpectra with MetaData and ChlData
```{r SpectraWide with MetaData}


SpectraMeta <- SpectraWide %>%
  left_join(., MetaData, by = c("ID"))

SpectraMeta <- SpectraMeta |>
  mutate(O2_uM = case_when(O2 == 0 ~ 2,
                           O2 == 1 ~ 25,
                           O2 == 21 ~ 250)) |>
  select(-c("...44", "...45", "DateOfAdjustment", "ElaspedHoursAtAdjustment", "Par_ueAdjusted", "Description", "Motivation"))
    
SpectraMeta <- SpectraMeta |>
  left_join(ChlData, join_by(ID == CultureID))
        
SpectraMeta |>
  ggplot() +
  geom_line(aes(x = nm, y = SecondDeriv_2), size = 0.5) +
  geom_line(aes(x = nm, y = SecondDeriv_250), size = 0.1, colour = "red") +
  facet_grid(cols = vars(Strain), rows = vars(Par_ue, O2_uM)) +
  coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()            

```
Spectra with MetaData
```{r spectra with metadata}
SpectraMeta |>
  ggplot() +
  geom_line(aes(x = nm, y = ANorm_2), size = 0.5) +
  geom_line(aes(x = nm, y = ANorm_250), size = 0.1, colour = "red") +
  facet_grid(cols = vars(Strain), rows = vars(Par_ue, O2_uM)) +
 # coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()   
```

Add Turner Chlorophyll data to estimate a* etc.
add Chl units
ask about adding a collum to catalog for sample time



```{r savespectra}
#filename Project_ExpDateYYYYMMDD_SpectraMeta.rds

saveRDS(SpectraMeta, file = file.path("..", "Data", "ProcessedData", paste(Project, Run,  "SpectraMeta.rds", sep = "_")))
```



Normalization
https://www.digitalocean.com/community/tutorials/normalize-data-in-r
```{r}
# OLISSpectraMetaNorm <- OLISSpectraMeta %>%
# summary(Absorbance) 
# process <- preProcess(as.data.frame(Absorbance), method=c("range")) %>% 
# norm_scale <- predict(process, as.data.frame(Absorbance))
  
```


```{r}

# OLISSpectraMetaPlot <- TargetSpectraLong2 %>%
# ggplot() +
#   geom_line(aes(x = nm, y = Absorbance, colour = as.factor(CultureID), label = CultureID), show.legend = "none", size = 1, linetype = "dotted") +
#   scale_color_manual(values = c("KACC0102" = "aquamarine4", "KACC0105" ="990066", "KACC0106" = "palegreen3", "KACC0108" = "pink", "KACC0114" = "yellowgreen")) +
#   labs(y = "Absorbance", x = "Wavelength (nm)") +
#   # scale_y_continuous(breaks=seq(0, 0.2, by = 0.05)) +
#   # coord_cartesian(ylim = c (0, 0.2)) +
#   theme_bw()
# OLISSpectraMetaPlot

```




```{r prelimplot2, fig.height = 6, fig.width = 8, warning = FALSE}
# 
# #dashed and solid color lines Norm440
# Absorbance440 <- OLISSpectraMeta %>% 
#   filter(nm == 440) %>%
#   mutate(Abs440 = Absorbance) %>%
#   select(ID, Strain, Abs440, Par_ue)
# 
# OLISSpectraMetaPlot <- OLISSpectraMeta %>%
#   filter(SpectraDate == "2022-05-23") %>% 
#   filter(Strain != "MIT9313") %>% 
#   filter(Strain != "SS120") %>% 
#   filter(Strain != "MED4") %>% 
#     filter(Strain != "132R") %>% 
#     filter(Strain != "48R") %>% 
#     filter(Strain != "56G") %>% 
#     filter(Strain != "60G") %>% 
#     filter(WL != "WW") %>% 
#   filter(Par_ue == "60" |
#         Par_ue == "300") %>% 
#   filter(Run != "56") %>% # nie
#   filter(Run != "59") %>% # niezly
#   filter(Run != "63") %>% # nie
#   filter(Run != "68") %>% # niezly
#   filter(Run == "70") %>% 
#   left_join(., Absorbance440) %>%
#   # group_by(WL, Strain, Par_ue) %>%
#   mutate(AbsNorm440 = Absorbance / Abs440) %>%
# 
#   ggplot() +
#   geom_line(aes(x = nm, y = AbsNorm440, label = ID, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", size = 1) +
#   #scale_color_manual(values = c("530" ="darkgreen", "660" = "red")) +
#   scale_linetype_manual(values=c("530" = "solid", "660" = "dashed")) +
#   scale_color_manual(values = c("530" ="darkgreen", "660" = "red")) +
#   guides(colour = FALSE, linotype = FALSE) +
#   labs(y = "Absorbance", x = "Wavelength (nm)") +
#   # scale_y_continuous(breaks=seq(0, 0.2, by = 0.05)) +
#   # coord_cartesian(ylim = c (0, 0.2)) +
#   ggh4x::facet_nested(rows = vars(Strain),cols = vars(Par_ue), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
#   theme_bw()
# OLISSpectraMetaPlot
# 
# 
# 
# #dashed and solid lines Norm710
# Absorbance710 <- OLISSpectraMeta %>% 
#   filter(nm == 710) %>%
#   mutate(Abs710 = Absorbance) %>%
#   select(ID, Strain, Abs710, Par_ue)
# 
# OLISSpectraMetaPlot <- OLISSpectraMeta %>%
#   filter(SpectraDate == "2022-05-23") %>% 
#   filter(Strain != "MIT9313") %>% 
#   filter(Strain != "SS120") %>% 
#   filter(Strain != "MED4") %>% 
#     filter(Strain != "132R") %>% 
#     filter(Strain != "48R") %>% 
#     filter(Strain != "56G") %>% 
#     filter(Strain != "60G") %>% 
#     filter(WL != "WW") %>% 
#   filter(Par_ue == "60" |
#         Par_ue == "300") %>% 
#   filter(Run != "56") %>% # nie
#   filter(Run != "59") %>% # niezly
#   filter(Run != "63") %>% # nie
#   filter(Run != "68") %>% # niezly
#   filter(Run == "70") %>% 
#   left_join(., Absorbance710) %>%
#   # group_by(WL, Strain, Par_ue) %>%
#   mutate(AbsNorm710 = Absorbance / Abs710) %>%
# 
#   ggplot() +
#   geom_line(aes(x = nm, y = AbsNorm710, label = ID, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", size = 1) +
#   scale_linetype_manual(values=c("530" = "solid", "660" = "dashed")) +
#   scale_color_manual(values = c("530" ="darkgreen", "660" = "red")) +
#   guides(colour = FALSE, linotype = FALSE) +
#   labs(y = "Absorbance", x = "Wavelength (nm)") +
#   # scale_y_continuous(breaks=seq(0, 0.2, by = 0.05)) +
#   # coord_cartesian(ylim = c (0, 0.2)) +
#   ggh4x::facet_nested(rows = vars(Strain),cols = vars(Par_ue), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
#   theme_bw()
# OLISSpectraMetaPlot
```

```{r}

# OLISSpectraMeta440 <- OLISSpectraMeta %>%
#   filter(Strain == "BA127R"|
#         Strain == "BA77G") %>% 
#   filter(Par_ue == "60" |
#         Par_ue == "300") %>% 
#   filter(Run == "70") %>% 
#   left_join(., Absorbance440) %>%
#   mutate(AbsNorm440 = Absorbance / Abs440) %>% 
#   filter(nm >= 400 & nm <= 700) 
#   
#  
# OLISSpectraMeta710 <- OLISSpectraMeta %>%
#   filter(Strain == "BA127R"|
#         Strain == "BA77G") %>% 
#   filter(Par_ue == "60" |
#         Par_ue != "300") %>% 
#   filter(Run == "70") %>% 
#   left_join(., Absorbance710) %>%
#   mutate(AbsNorm710 = Absorbance / Abs710) 
```

```{r prelimplot2, fig.height = 6, fig.width = 8, warning = FALSE}
# #dashed and solid color lines Norm440
# 
# OLISSpectraMeta440Plot <- OLISSpectraMeta440 %>%
#   ggplot() +
#   geom_line(aes(x = nm, y = AbsNorm440, label = ID, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", size = 1) +
#   #scale_color_manual(values = c("530" ="darkgreen", "660" = "red")) +
#   scale_linetype_manual(values=c("530" = "solid", "660" = "dashed")) +
#   scale_color_manual(values = c("530" ="darkgreen", "660" = "red")) +
#   guides(colour = FALSE, linotype = FALSE) +
#   labs(y = "Absorbance", x = "Wavelength (nm)") +
#   # scale_y_continuous(breaks=seq(0, 0.2, by = 0.05)) +
#   # coord_cartesian(ylim = c (0, 0.2)) +
#   ggh4x::facet_nested(rows = vars(Strain),cols = vars(Par_ue), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
#   theme_bw()
# OLISSpectraMeta440Plot
# 
# 
# OLISSpectraMeta710Plot <- OLISSpectraMeta710 %>%
#   ggplot() +
#   geom_line(aes(x = nm, y = AbsNorm710, label = ID, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", size = 1) +
#   #scale_color_manual(values = c("530" ="darkgreen", "660" = "red")) +
#   scale_linetype_manual(values=c("530" = "solid", "660" = "dashed")) +
#   scale_color_manual(values = c("530" ="darkgreen", "660" = "red")) +
#   guides(colour = FALSE, linotype = FALSE) +
#   labs(y = "Absorbance", x = "Wavelength (nm)") +
#   # scale_y_continuous(breaks=seq(0, 0.2, by = 0.05)) +
#   # coord_cartesian(ylim = c (0, 0.2)) +
#   ggh4x::facet_nested(rows = vars(Strain),cols = vars(Par_ue), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
#   theme_bw()
# OLISSpectraMeta710Plot
# ```

#Turner Data




#```{r prelimplot2, fig.height = 6, fig.width = 8, warning = FALSE}
# #dashed and solid color lines Norm440
# data_text <- data.frame(
#   WL   = c("530", "660"),
#   Strain  = c("BA127R", "BA77G"),
#   label = c('A)', 'B)'))
# 
# OLISSpectraMetaAllPlot <- OLISSpectraMetaAll %>%
#   filter(Par_ue == 60) %>% 
#   ggplot() +
#   geom_line(aes(x = nm, y = AbsNorm440, label = ID, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", lwd=0.7) +
#   geom_line(aes(x = nm, y = EmNormJaz647, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", lwd=0.7) +
#   geom_line(aes(x = nm, y = EmNormJaz521, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", lwd=0.7) +
#   geom_text(data=data_text, aes(x=400, y=1.15, label=label), size=5) +
#   #scale_color_manual(values = c("530" ="darkgreen", "660" = "red")) +
#   scale_linetype_manual(values=c("530" = "solid", "660" = "97", "531" = "2468", "661" = "dotdash")) +
#   scale_color_manual(values = c("530" ="palegreen4", "660" = "brown3", "531" ="palegreen4", "661" = "brown3")) +
#   guides(colour = FALSE, linotype = FALSE) +
#   labs(y = "Absorbance", x = "Wavelength (nm)") +
#   scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
#   coord_cartesian(ylim = c (0, 1.3)) +
#   ggh4x::facet_nested(rows = vars(Strain), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
#   theme_bw() +
#       theme(panel.grid.minor = element_blank(),
#         axis.text = element_text(size=12),
#         axis.title = element_text(size=14),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.92,0.94),
#         legend.text = element_text(size=12))
# OLISSpectraMetaAllPlot
# 
# 
# OLISSpectraMetaAllPlot <- OLISSpectraMetaAll %>%
#   filter(Par_ue == 300) %>% 
#   ggplot() +
#   geom_line(aes(x = nm, y = AbsNorm440, label = ID, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", lwd=0.7) +
#   geom_line(aes(x = nm, y = EmNormJaz647, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", lwd=0.7) +
#   geom_line(aes(x = nm, y = EmNormJaz521, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", lwd=0.7) +
#   geom_text(data=data_text, aes(x=400, y=1.15, label=label), size=5) +
#   #scale_color_manual(values = c("530" ="darkgreen", "660" = "red")) +
#   scale_linetype_manual(values=c("530" = "solid", "660" = "97", "531" = "2468", "661" = "dotdash")) +
#   scale_color_manual(values = c("530" ="palegreen4", "660" = "brown3", "531" ="palegreen4", "661" = "brown3")) +
#   guides(colour = FALSE, linotype = FALSE) +
#   labs(y = "Absorbance", x = "Wavelength (nm)") +
#   scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
#   coord_cartesian(ylim = c (0, 1.3)) +
#   ggh4x::facet_nested(rows = vars(Strain), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
#   theme_bw() +
#       theme(panel.grid.minor = element_blank(),
#         axis.text = element_text(size=12),
#         axis.title = element_text(size=14),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.92,0.94),
#         legend.text = element_text(size=12))
# OLISSpectraMetaAllPlot

```

```{r}
# OLISSpectraMetaAll2 <- OLISSpectraMeta710 %>%
#   full_join(., JazData710, by = c("Par_ue" = "Par", "nm" = "Wavelength", "AbsNorm710" = "Counts10000", "WL" = "WL", "Strain" = "Strain")) %>% 
#   unique()
# #colnames(O2MetaAll)
```


```{r prelimplot2, fig.height = 6, fig.width = 8, warning = FALSE}
#dashed and solid color lines Norm710
# OLISSpectraMetaAll2Plot <- OLISSpectraMetaAll2 %>%
#   ggplot() +
#   geom_line(aes(x = nm, y = AbsNorm710, label = ID, linetype = as.factor(WL), colour = as.factor(WL)), show.legend = "none", size = 1) +
#   #scale_color_manual(values = c("530" ="darkgreen", "660" = "red")) +
#   scale_linetype_manual(values=c("530" = "dotted", "660" = "dotdash", "531" = "solid", "661" = "longdash")) +
#   scale_color_manual(values = c("530" ="darkgreen", "660" = "red", "531" ="darkgreen", "661" = "red")) +
#   guides(colour = FALSE, linotype = FALSE) +
#   labs(y = "Absorbance", x = "Wavelength (nm)") +
#   scale_y_continuous(breaks=seq(0, 10, by = 2.5)) +
#   coord_cartesian(ylim = c (0, 10)) +
#   ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue), labeller = labeller(Ex_WL = label_both, strain = label_value, WL = label_both, Photoperiod = label_both, Par_ue = label_both)) +
#   theme_bw()
# OLISSpectraMetaAll2Plot
```



```{r}
# OLISSpectraMetaPlot %>%
#   plotly::ggplotly()
```


```{r}
# TargetSpectraLong %>% 
#   group_by(SampleID, nm) %>%
#   # filter(SpectraDate == 20220822) %>%
#   summarize(SpectraDate, nm, Absorbance, SampleID, Source,  meanAbsorbance = mean(Absorbance), seAbsorbance = sd(Absorbance)/n()^(1/2)) %>%
#   ggplot() +
#   geom_point(aes(x = nm, y = meanAbsorbance, colour = SpectraDate), size = 0.1, show.legend = FALSE) +
#   geom_ribbon(aes(x = nm, ymin = meanAbsorbance - seAbsorbance, ymax = meanAbsorbance + seAbsorbance, fill = SpectraDate), alpha = 0.1, show.legend = FALSE) +
#   # scale_x_continuous(limits = c(400, 700), breaks = c()) +
#   labs(x = "Wavelength (nm)",
#        y = "Absorbance") +
#   theme_bw() +
#   facet_grid(rows = vars(Source))
```



```{r save Olis}

#saveRDS(olis_spectra, file = "olis_spectra.rds")
```


```{r save growth_long}
#saveRDS(growth_long, file = file.path("process_data",paste(project,file_id_single, "growth_long", ".Rds",sep = "_"),fsep = .Platform$file.sep))
```
