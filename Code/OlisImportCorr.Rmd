---
title: "Import OLIS spectral data data"
author: "Douglas A. Campbell, Sylwia Sliwinska-Wilczewska, Sarah Gore, Adrian Kryk"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

# Import spectral files generated by OLIS spectrophotometer
Subtract media baseline spectra
Normalize spectra to peak absorbance
Calculate difference between 2 and 250 uM O2
Calculate second derivative spectra

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

```{r set project variables}
Project <- "PICO"
Run <- "O2Analyses"

DataOut <- file.path("..", "Data", "ProcessedData", fsep = .Platform$file.sep)

DataIn <- file.path("..", "Data", "RawData", "OLIS", fsep = .Platform$file.sep)

FileID <- ".txt"

Catalog <- "https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0"

ChlTurner <- "https://docs.google.com/spreadsheets/d/13mQm0B3siS65UuGjNdzvpHFomfuwn6aAg7dBoq1IqrM/edit#gid=0"

FileEncode <- "UTF-8" 
Delimiter <- ""

HeaderRows <- 0
```


```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(broom)
#library(OneR)
library(zoo)
#library(strucchange)

library(googledrive)
library(googlesheets4)
library(readxl)

library(ggspectra)
library(ggpubr)
library(caret)
library(photobiologyWavebands)
```

Load Multiculti catalog and ChlTurner
```{r load multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

# imagine this is the URL or ID of a Sheet readable by anyone (with a link)
# MultiCulti metadata
MetaData <- read_sheet(Catalog) |>
  # read_sheet has an annoying "feature" to set the type of columns it can't parse to a list.
  # ggplot/dplyr doesn't like working with a dataframe of lists.
  # In this case WL is set to a list since some values are numbers, some are strings, some are blank.
  # To fix this, first drop all rows missing WL, then unlist.
  # Must first drop NA rows since unlist will collapse NULL lists, then the unlisted WL is a shorter length than original WL column, which mutate doesn't like.
  drop_na(WL) %>%
  mutate(WL = unlist(WL)) |>
  filter(!str_detect(string = Description, pattern = "czech")) |> # remove 'duplicate' SampleID rows from MetaData
  select(-c("Description", "Motivation", "doi", "Par_ueAdjusted", "DateOfAdjustment", "ElaspedHoursAtAdjustment", "...45", "...46"))

as.data.frame(MetaData)

MetaData <- MetaData |>
   mutate(ExpDate = lubridate::ymd(ExpDate),
          ExpEndDate = lubridate::ymd_hms(`ExpEndDate`)) |>
    filter(str_detect(string = SampleID, pattern = "JuNa|MiSa")) #simplify MetaData to only include JuNa or MiSa samples

# find units for chl
ChlData <- read_sheet(ChlTurner) |>
  mutate(Chl = as.numeric(Reading_rfu) * as.numeric(Chl_slope) + as.numeric(Chl_intercept))

```


```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c(w_length2rgb(Wavelengths_nm[1]), w_length2rgb(Wavelengths_nm[2]), w_length2rgb(Wavelengths_nm[3]), w_length2rgb(Wavelengths_nm[4]), w_length2rgb(Wavelengths_nm[5]))

names(Colours_nm) <- Wavelengths_nm
Colours_nm

```

For SySl files 'baseline' in filename means baseline spectra already subtracted within OLIS software.
This was not universallly true across all projects; be careful.
For SySl files 'raw' means spectra of undiluted culture; other spectra are 1 or 4 ml culture + 8 or 4 ml media.

Ideally: we want to read and tidy some user-selected set of files taken from multiple dates

Julie did a Pro99_baseline file for each set of OLIS measurements.
So there should be a separate Pro99_baseline file for each measurement date.
So in principle we should match Spectra with date-specific Pro99_baseline files.

```{r list available OLIS Files}
OlisFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE)
OlisFiles

#test for duplicate file names
unique(duplicated(OlisFiles))
```


# set up read_delim_plus
```{r}
# #make this more robust to variable file formats
#FileEncode <- "UTF-8"
#Delimiter <- ""
# #.asc files from export from OLIS seem to use spaces as delimiter
# 
#HeaderRows <- 0

read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(file = flnm, header = FALSE, fileEncoding = filencode, sep = delimiter,  skip = headerrows,  row.names = NULL) %>%
     mutate(Filename = flnm)
}

#header = TRUE,

#read.delim_long meant for map over a vector of filepaths to read, convert to long format and tidy the imported data
# read.delim_long <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
#     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime)) %>%
#  rename(nm = OLIS.3D.ASCII) %>%
#   mutate(FirstLastSpec = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_")) %>%
#   mutate(SampleNumbers = str_extract_all(FirstLastSpec, "[:digit:][:digit:][:digit:][:digit:]")) %>%
#   mutate(FirstSampleNumber = as.numeric(map(SampleNumbers, ~.[[1]]))) %>%
#   mutate(LastSampleNumber = as.numeric(map(SampleNumbers, ~.[[2]]))) %>%
#   mutate(OperatorID = str_extract(Filename,"[A-Z][a-z][A-Z][a-z]")) %>%
#   pivot_longer(cols = starts_with("X"), names_to = "SpectraID", values_to = "Abs") %>%
#   mutate(SampleCode = as.numeric(str_remove(SpectraID, "X"))) %>%
#   mutate(SampleNumber = SampleCode - min(SampleCode, na.rm = TRUE) + FirstSampleNumber) %>%
#   relocate(OperatorID, SampleNumber) %>%
#   unite(col = SampleID, OperatorID:SampleNumber, sep = "", remove = FALSE) %>%
#   arrange(SampleID, nm) %>%
#   relocate(SampleID, nm, Abs) %>%
#   mutate(SpectraDate = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
#          SpectraDate = str_remove_all(SpectraDate, "_"),
#          SpectraDate = str_remove_all(SpectraDate, "/"),
#          SpectraDate = ymd(SpectraDate)
#   )
# }
```


# Import OLIS files
Issue with Baseline vs. Pro99
```{r importspecific OLIS file}

Spectra <- OlisFiles |> 
  map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows)) |>
  rename(nm = V1,
         A = V2) |>
  mutate(Filename = str_remove(string = Filename, pattern = "../Data/RawData/OLIS/")) |>
  mutate(Filename = str_remove(string = Filename, pattern = ".txt")) |>
    separate(col = Filename, into = c("Project", "DateTime", "ID", "O2_uM"), sep = "([\\/\\_\\:])", remove = FALSE) |>
  mutate(DateTime = lubridate::ymd_hm(DateTime))

  
Spectra %>%
  ggplot() +
  geom_point(aes(x = nm, y = A)) +
  facet_grid(rows = vars(ID), cols = vars(O2_uM)) +
  theme_bw()
```

# Subtract baseline
```{r subtract baseline}
Baseline <- Spectra |>
  filter(ID == "Pro99")

Baseline %>%
  ggplot() +
  geom_point(aes(x = nm, y = A)) +
  facet_grid(rows = vars(ID), cols = vars(Filename)) +
  theme_bw()

unique(Baseline$DateTime)

#Incorrect matching b/t actual spectra and appropriate baselines...
Spectra <- Spectra |>
  filter(ID != "Pro99" )


|>
  mutate(ABase = A - Baseline$A)  |>
  group_by(ID, O2_uM) |>
  mutate(ANorm = ABase/max(ABase)) |>
  ungroup()

Spectra |>
  ggplot() +
  geom_point(aes(x = nm, y = ABase)) +
  facet_grid(rows = vars(ID), cols = vars(O2_uM)) +
  theme_bw()

Spectra |>
  ggplot() +
  geom_point(aes(x = nm, y = ANorm)) +
  facet_grid(rows = vars(ID), cols = vars(O2_uM)) +
  theme_bw()

```

# 2nd derivative spectra to detect small shifts in absorbance
```{r second derivative}
#https://stackoverflow.com/questions/49762128/rolling-regression-by-group-in-the-tidyverse?noredirect=1&lq=1

#function to generate slope from ratio of covariance to variance
 slope <- . %>% { cov(.[, 2], .[, 1]) / var(.[, 2])}
 
#range rolling window variables; be careful with different data sets
 NmperRow <- ((Baseline$nm[length(Baseline$nm)]- Baseline$nm[1]) +1)/nrow(Baseline)

FirstRange <- 10
SecondRange <- 10

Spectra <- Spectra %>%
  group_by(Filename) %>%
  mutate(FirstDeriv = rollapplyr(cbind(ANorm, nm), FirstRange, slope, by.column = FALSE, align = 'right', fill = NA)) %>%
  mutate(SecondDeriv = rollapplyr(cbind(FirstDeriv, nm), SecondRange, slope, by.column = FALSE, align = 'right', fill = NA)) %>%
     ungroup()


# 
# #different approach
# olis_spectra <- olis_spectra %>%
#   group_by(filename) %>%
#   mutate(diffnm = nm - lag(nm, n =  FirstRange),
#          diffAbs750_0 = Abs750_0 - lag(Abs750_0, n = FirstRange),
#          dAdnm = diffAbs750_0/diffnm) %>%
#   mutate(SecondDriveAlt = dAdnm/FirstRange) %>%
#   ungroup()
# ```
# 
# 
```

```{r second deriv plots}
Spectra |>
  ggplot() +
  geom_point(aes(x = nm, y = SecondDeriv)) +
  facet_grid(rows = vars(ID), cols = vars(O2_uM)) +
  theme_bw()
```


# Pivot 2 and 250 ÂµM O2 data into separate columns
```{r uM O2 separate columns}
SpectraWide <- Spectra |>
  pivot_wider(id_cols = c(nm, Project, ID), names_from = c(O2_uM), values_from = c(Filename, A, ABase, ANorm, FirstDeriv, SecondDeriv))


SpectraWide |>
  ggplot() +
  geom_point(aes(x = nm, y = ABase_2)) +
  #geom_point(aes(x = nm, y = ABase_250), colour = "red") +
  #facet_grid(rows = vars(ID)) +
  theme_bw()

 head(SpectraWide)
 
SpectraWide |>
  ggplot() +
  geom_point(aes(x = nm, y = SecondDeriv_2)) +
  geom_point(aes(x = nm, y = SecondDeriv_250), colour = "red") +
  facet_grid(rows = vars(ID)) +
  theme_bw()

SpectraWide |>
  ggplot() +
  geom_line(aes(x = nm, y = SecondDeriv_2), linewidth = 0.5) +
  geom_line(aes(x = nm, y = SecondDeriv_250), linewidth = 0.1, colour = "red") +
  facet_grid(cols = vars(ID)) +
  coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()

```


# Difference spectra
```{r difference spectra}

SpectraWide <- SpectraWide |>
  mutate(A2sub250 = ANorm_2 - ANorm_250)

SpectraWide |>
  ggplot() +
  geom_point(aes(x = nm, y = A2sub250 * 10)) +
  geom_point(aes(x = nm, y = ABase_2), colour = "red") +
  facet_grid(rows = vars(ID)) +
  theme_bw()
```


# Merge OLISSpectra with MetaData and ChlData

> SpectraMeta <- SpectraWide %>% -->
<!-- +   left_join(., MetaData, by = c("ID" = "SampleID")) -->
<!-- Warning: Detected an unexpected many-to-many relationship between `x` and `y`. -->
#Issue is with samples from czech that have repeated SampleID; fixed by filter on MetaData

```{r SpectraWide with MetaData}
SpectraMeta <- SpectraWide %>%
  left_join(., MetaData, by = c("ID" = "SampleID"))

SpectraMeta <- SpectraMeta |>
  mutate(O2_uM = case_when(O2 == 0 ~ 2,
                           O2 == 2 ~ 25,
                           O2 == 21 ~ 250)) 
    
SpectraMeta <- SpectraMeta |>
  left_join(ChlData, join_by(ID == CultureID))
        


SpectraMeta |>
  ggplot() +
  geom_line(aes(x = nm, y = SecondDeriv_2), linewidth  = 0.5) +
  geom_line(aes(x = nm, y = SecondDeriv_250), linewidth = 0.1, colour = "red") +
  facet_grid(rows = vars(Strain), cols = vars(Par_ue, O2_uM)) +
  coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()   

SpectraMeta |>
  filter(Strain == "MED4") |>
  #filter(Par_ue != 180) |>
  filter(ID != "JuNa1200") |>
  ggplot() +
  geom_line(aes(x = nm, y = SecondDeriv_2), linewidth  = 0.5) +
  geom_line(aes(x = nm, y = SecondDeriv_250), linewidth = 0.1, colour = "red") +
  facet_grid(rows = vars(O2_uM), cols = vars(Par_ue)) +
  coord_cartesian(xlim = c(500, 600)) + 
  theme_bw() 
  
  SpectraMeta |>
  filter(Par_ue == 30) |>
  filter(O2_uM == 250) |>
  ggplot() +
  geom_line(aes(x = nm, y = SecondDeriv_2), linewidth  = 0.5) +
  geom_line(aes(x = nm, y = SecondDeriv_250), linewidth = 0.1, colour = "red") +
  facet_grid(rows = vars(Strain), cols = vars(Par_ue, O2_uM)) +
  coord_cartesian(xlim = c(500, 600), ylim = c(-0.002, 0.001)) + 
  theme_bw()   
  
  SpectraMeta |>
  filter(Par_ue == 30) |>
  filter(O2_uM == 250) |>
  ggplot() +
  geom_line(aes(x = nm, y = (SecondDeriv_2 - SecondDeriv_250), colour = ID)) +
  facet_grid(rows = vars(Strain), cols = vars(Par_ue, O2_uM)) +
  coord_cartesian(xlim = c(500, 600), ylim = c(-0.002, 0.001)) + 
  theme_bw() 
  
    SpectraMeta |>
  filter(Par_ue == 90) |>
  filter(O2_uM == 250) |>
  ggplot() +
  geom_line(aes(x = nm, y = (SecondDeriv_2 - SecondDeriv_250), colour = ID)) +
  facet_grid(rows = vars(Strain), cols = vars(Par_ue, O2_uM)) +
  coord_cartesian(xlim = c(500, 600), ylim = c(-0.002, 0.001)) + 
  theme_bw()   

```
https://resources.amsbio.com/Datasheets/KC310100.pdf
https://pubs.acs.org/doi/10.1021/cr400479b#
Hint of Cytb oxidation/reduction?

Spectra with MetaData
```{r spectra with metadata}
SpectraMeta |>
  ggplot() +
  geom_line(aes(x = nm, y = ANorm_2), size = 0.5) +
  geom_line(aes(x = nm, y = ANorm_250), size = 0.1, colour = "red") +
  facet_grid(cols = vars(Strain), rows = vars(Par_ue, O2_uM, ID)) +
 # coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()   

SpectraMeta |>
  ggplot() +
  geom_line(aes(x = nm, y = ANorm_2 - ANorm_250), size = 0.5) +
  facet_grid(cols = vars(Strain), rows = vars(Par_ue, O2_uM, ID)) +
 # coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()   

SpectraMeta |>
  filter(Par_ue == 30) |>
  filter(O2_uM == 250) |>
  ggplot() +
  geom_line(aes(x = nm, y = ANorm_2 - ANorm_250, colour = ID), size = 0.5) +
  facet_grid(rows = vars(Strain), cols = vars(Par_ue, O2_uM)) + 
  coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()   

SpectraMeta |>
  filter(Par_ue == 90) |>
  filter(O2_uM == 25) |>
  ggplot() +
  geom_line(aes(x = nm, y = ANorm_2 - ANorm_250, colour = ID), size = 0.5) +
  facet_grid(rows = vars(Strain), cols = vars(Par_ue, O2_uM)) + 
  coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()  

SpectraMeta |>
  filter(Par_ue == 90) |>
  filter(O2_uM == 250) |>
  ggplot() +
  geom_line(aes(x = nm, y = ANorm_2 - ANorm_250, colour = ID), size = 0.5) +
  facet_grid(rows = vars(Strain), cols = vars(Par_ue, O2_uM)) + 
  coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()  

SpectraMeta |>
  filter(Strain == "MED4") |>
  # filter(Par_ue == 90) |>
  # filter(O2_uM == 250) |>
  ggplot() +
  geom_line(aes(x = nm, y = ANorm_2 - ANorm_250, colour = ID), size = 0.5) +
  facet_grid(rows = vars(Strain), cols = vars(Par_ue, O2_uM)) + 
  coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()  

SpectraMeta |>
  filter(Strain == "MED4") |>
  ggplot() +
  geom_line(aes(x = nm, y = ANorm_2), size = 0.5) +
  geom_line(aes(x = nm, y = ANorm_250), size = 0.1, colour = "red") +
  facet_grid(cols = vars(Strain), rows = vars(Par_ue, O2_uM, ID)) +
  coord_cartesian(xlim = c(500, 600)) + 
  theme_bw()   



```

Add Turner Chlorophyll data to estimate a* etc.
add Chl units
ask about adding a collum to catalog for sample time



```{r savespectra}
#filename Project_ExpDateYYYYMMDD_SpectraMeta.rds

#saveRDS(SpectraMeta, file = file.path("..", "Data", "ProcessedData", paste(Project, Run,  "SpectraMeta.rds", sep = "_")))
```


Normalization
https://www.digitalocean.com/community/tutorials/normalize-data-in-r
```{r}
# OLISSpectraMetaNorm <- OLISSpectraMeta %>%
# summary(Absorbance) 
# process <- preProcess(as.data.frame(Absorbance), method=c("range")) %>% 
# norm_scale <- predict(process, as.data.frame(Absorbance))
  
```

